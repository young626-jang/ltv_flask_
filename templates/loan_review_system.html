<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ë§ë‹´ë³´ì»¨ì„¤íŒ…ëŒ€ë¶€ - ëŒ€ì¶œ ì‹¬ì‚¬ í˜„í™© ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2a5298;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3c72;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .table-wrapper {
            overflow-x: auto;
            padding: 20px 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th {
            background: #2a5298;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tr:hover {
            background: #f0f0f0;
        }
        
        .status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.ì ‘ìˆ˜ { background: #e8eaf6; color: #3f51b5; }
        .status.ì‹¬ì‚¬ì¤‘ { background: #e3f2fd; color: #1976d2; }
        .status.ë‹´ë³´ê°€ì¹˜í™•ì¸ { background: #e3f2fd; color: #1976d2; }
        .status.ì‹ ìš©ì¡°íšŒ { background: #e3f2fd; color: #1976d2; }
        .status.ì‹¬ì‚¬ì™„ë£Œ { background: #e8f5e9; color: #388e3c; }
        .status.ì„œë¥˜ë°œê¸‰ { background: #fff3e0; color: #f57c00; }
        .status.ìì„œì˜ˆì • { background: #fff3e0; color: #f57c00; }
        .status.ìì„œì™„ë£Œ { background: #f3e5f5; color: #7b1fa2; }
        .status.ì†¡ê¸ˆì™„ë£Œ { background: #c8e6c9; color: #2e7d32; }
        .status.ë°˜ë ¤ { background: #ffebee; color: #c62828; }
        
        .amount {
            text-align: right;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2a5298;
        }
        
        .summary-card h3 {
            font-size: 12px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .summary-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #2a5298;
        }
        
        .edit-btn, .delete-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 3px;
        }
        
        .edit-btn {
            background: #2196F3;
            color: white;
        }
        
        .delete-btn {
            background: #f44336;
            color: white;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @media print {
            body { padding: 0; }
            .controls { display: none; }
            .modal { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ë™ì  ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ (íƒ€ì„ë¼ì¸, ê¸°ë¡, ë©”ëª¨ ë“±) -->
        <div id="modalContainer"></div>

        <div class="header">
            <h1>ğŸ¦ ëŒ€ì¶œ ì‹¬ì‚¬ í˜„í™© ê´€ë¦¬</h1>
            <p>í¬ë§ë‹´ë³´ì»¨ì„¤íŒ…ëŒ€ë¶€ | ê³ ê° ì ‘ìˆ˜ â†’ ì‹¬ì‚¬ â†’ ì„œë¥˜ë°œê¸‰ â†’ ìì„œ â†’ ì†¡ê¸ˆ</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">+ ê³ ê° ì¶”ê°€</button>
            <button class="btn btn-secondary" onclick="exportData()">ğŸ“Š ë‚´ë³´ë‚´ê¸° (CSV)</button>
            <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ê³ ê°ëª… ë˜ëŠ” íœ´ëŒ€í°ìœ¼ë¡œ ê²€ìƒ‰..." onkeyup="searchData()">
            </div>
        </div>

        <div id="bulkControls" style="padding: 15px 30px; background: #fff3e0; border-bottom: 1px solid #e0e0e0; display: none; gap: 10px; flex-wrap: wrap; align-items: center;">
            <span id="selectedCount" style="font-weight: 600;">ì„ íƒë¨: 0ê°œ</span>
            <button class="btn btn-secondary" onclick="toggleSelectAll()">ëª¨ë‘ ì„ íƒ</button>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                <span style="font-size: 13px; font-weight: 600; align-self: center;">ì¼ê´„ ë³€ê²½:</span>
                <button class="btn" style="background: #4CAF50; color: white; padding: 8px 12px; font-size: 12px;" onclick="bulkChangeStatus('ì‹¬ì‚¬ì¤‘')">ì‹¬ì‚¬ì¤‘</button>
                <button class="btn" style="background: #2196F3; color: white; padding: 8px 12px; font-size: 12px;" onclick="bulkChangeStatus('ìì„œì˜ˆì •')">ìì„œì˜ˆì •</button>
                <button class="btn" style="background: #FF9800; color: white; padding: 8px 12px; font-size: 12px;" onclick="bulkChangeStatus('ì†¡ê¸ˆ')">ì†¡ê¸ˆ</button>
                <button class="btn" style="background: #f44336; color: white; padding: 8px 12px; font-size: 12px;" onclick="bulkChangeStatus('ë³´ë¥˜')">ë³´ë¥˜</button>
                <button class="btn" style="background: #e91e63; color: white; padding: 8px 12px; font-size: 12px;" onclick="bulkDelete()">ì‚­ì œ</button>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAll()" style="cursor: pointer; width: 18px; height: 18px;"></th>
                        <th>No</th>
                        <th>ê³ ê°ëª…</th>
                        <th>íœ´ëŒ€í°</th>
                        <th>ìƒë…„ì›”ì¼</th>
                        <th>ë‹´ë³´í‰ê°€ì•¡</th>
                        <th>ì‹ ì²­ê¸ˆì•¡</th>
                        <th>ì§„í–‰ìƒíƒœ</th>
                        <th>ì‹ ìš©ì¡°íšŒ</th>
                        <th>ìì„œì˜ˆì •</th>
                        <th>ìì„œì™„ë£Œ</th>
                        <th>ì†¡ê¸ˆ</th>
                        <th>ë‹´ë‹¹ì</th>
                        <th>ê¸°ëŠ¥</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
            <div id="emptyMessage" class="empty-message">
                ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. '+ ê³ ê° ì¶”ê°€' ë²„íŠ¼ìœ¼ë¡œ ê³ ê° ì •ë³´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
            </div>
        </div>
        
        <div class="summary">
            <div class="summary-card">
                <h3>ì „ì²´ ê±´ìˆ˜</h3>
                <div class="value" id="totalCount">0</div>
            </div>
            <div class="summary-card">
                <h3>ì‹¬ì‚¬ì¤‘</h3>
                <div class="value" id="reviewingCount">0</div>
            </div>
            <div class="summary-card">
                <h3>ì‹¬ì‚¬ì™„ë£Œ</h3>
                <div class="value" id="completedCount">0</div>
            </div>
            <div class="summary-card">
                <h3>ì†¡ê¸ˆì™„ë£Œ</h3>
                <div class="value" id="sentCount">0</div>
            </div>
        </div>
    </div>
    
    <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ê³ ê° ì •ë³´ ì¶”ê°€</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="dataForm" onsubmit="saveData(event)">
                <input type="hidden" id="editIndex">
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ê³ ê°ëª… *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>íœ´ëŒ€í° *</label>
                        <input type="tel" id="phone" placeholder="010-0000-0000" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ìƒë…„ì›”ì¼</label>
                        <input type="date" id="birthDate">
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë³´í‰ê°€ì•¡</label>
                        <input type="number" id="collateralValue" min="0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹ ì²­ê¸ˆì•¡</label>
                        <input type="number" id="loanAmount" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì§„í–‰ìƒíƒœ</label>
                        <select id="status">
                            <option>ì ‘ìˆ˜</option>
                            <option>ì‹¬ì‚¬ì¤‘</option>
                            <option>ìì„œì˜ˆì •</option>
                            <option>ìì„œì™„ë£Œ</option>
                            <option>ì†¡ê¸ˆ</option>
                            <option>ë³´ë¥˜</option>
                            <option>ì·¨ì†Œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ë‹´ë‹¹ì</label>
                        <input type="text" id="manager">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ì‹ ìš©ì¡°íšŒ</label>
                        <select id="creditCheckDate">
                            <option value="">ë¯¸ì¡°íšŒ</option>
                            <option value="yes">ì™„ë£Œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìì„œì˜ˆì •ì¼</label>
                        <input type="date" id="contractScheduleDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ìì„œì™„ë£Œì¼</label>
                        <input type="date" id="contractCompleteDate">
                    </div>
                    <div class="form-group">
                        <label>ì†¡ê¸ˆì¼</label>
                        <input type="date" id="remitDate">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allData = [];
        let selectedRows = new Set();

        // Flask í…œí”Œë¦¿ì—ì„œ ì „ë‹¬ë°›ì€ ê³ ê°ì •ë³´
        const urlCustomerName = '{{ customer_name }}';
        const urlBirthDate = '{{ birth_date }}';

        // ìƒë…„ì›”ì¼ í˜•ì‹ ë³€í™˜ í•¨ìˆ˜ (640606 â†’ 1964-06-06)
        function formatBirthDate(birthStr) {
            if (!birthStr) return '';
            const cleaned = birthStr.replace(/\D/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ
            if (cleaned.length < 6) return '';

            const year = parseInt(cleaned.substring(0, 2));
            const month = cleaned.substring(2, 4);
            const day = cleaned.substring(4, 6);

            // 2000ë…„ëŒ€ ê¸°ì¤€ íŒë‹¨ (00~í˜„ì¬ë…„ë„ 2ìë¦¬ëŠ” 20xx, ê·¸ ì´ìƒì€ 19xx)
            const currentYear = new Date().getFullYear();
            const twoDigitYear = currentYear % 100;
            const fullYear = year <= twoDigitYear ? 2000 + year : 1900 + year;

            return `${fullYear}-${month}-${day}`;
        }

        // ìƒíƒœ ì§„í–‰ ìˆœì„œ
        const statusFlow = [
            'ì ‘ìˆ˜',
            'ì‹¬ì‚¬ì¤‘',
            'ìì„œì˜ˆì •',
            'ìì„œì™„ë£Œ',
            'ì†¡ê¸ˆ',
            'ë³´ë¥˜',
            'ì·¨ì†Œ'
        ];

        // ìƒíƒœë³„ ë‚ ì§œ í•„ë“œ ë§¤í•‘
        const statusDateMapping = {
            'ìì„œì˜ˆì •': 'contractScheduleDate',
            'ìì„œì™„ë£Œ': 'contractCompleteDate',
            'ì†¡ê¸ˆ': 'remitDate'
        };

        // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ (í•˜ì´ë¸Œë¦¬ë“œ: ì„œë²„ ìš°ì„ , ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì‚¬ìš©)
        async function loadData() {
            try {
                // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
                const response = await fetch('/api/loan-review-data', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const serverData = await response.json();
                    // ì„œë²„ ë°ì´í„°ë¥¼ ë¡œì»¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    allData = serverData.map(item => ({
                        id: item.id,
                        customerName: item.customerName,
                        phone: item.phone,
                        birthDate: item.birthDate,
                        collateralValue: item.collateralValue,
                        loanAmount: item.loanAmount,
                        status: item.status,
                        creditCheckDate: item.creditCheckDate,
                        contractScheduleDate: item.contractScheduleDate,
                        contractCompleteDate: item.contractCompleteDate,
                        remitDate: item.remitDate,
                        manager: item.manager,
                        statusHistory: item.statusHistory || [],
                        memoHistory: item.memoHistory || []
                    }));
                    // ì„œë²„ ë°ì´í„°ë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ë„ ì €ì¥ (ì˜¤í”„ë¼ì¸ ëŒ€ë¹„)
                    localStorage.setItem('loanReviewData', JSON.stringify(allData));
                } else {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
            } catch (error) {
                console.warn('ì„œë²„ ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©:', error);
                // ì„œë²„ ì‹¤íŒ¨ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ
                const saved = localStorage.getItem('loanReviewData');
                if (saved) {
                    allData = JSON.parse(saved);
                }
            }

            // ë°ì´í„° ê²€ì¦: íˆìŠ¤í† ë¦¬ ì—†ìœ¼ë©´ ì¶”ê°€
            allData.forEach(data => {
                if (!data.statusHistory) {
                    data.statusHistory = [{status: data.status, date: new Date().toISOString()}];
                }
                if (!data.memoHistory) {
                    data.memoHistory = [];
                }
            });

            renderTable();
            updateSummary();

            // LTV ê³„ì‚°ê¸°ì—ì„œ ë„˜ì–´ì˜¨ ê³ ê°ì •ë³´ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ëª¨ë‹¬ ì—´ê¸° (í•œ ë²ˆë§Œ)
            const hasProcessedUrlParams = sessionStorage.getItem('urlParamsProcessed');
            if (!hasProcessedUrlParams && urlCustomerName && urlCustomerName.trim() !== '') {
                setTimeout(() => {
                    document.getElementById('editIndex').value = '';
                    document.getElementById('customerName').value = urlCustomerName;
                    const formattedBirth = formatBirthDate(urlBirthDate);
                    document.getElementById('birthDate').value = formattedBirth;
                    document.getElementById('modalTitle').innerText = 'ê³ ê° ì •ë³´ ì¶”ê°€';
                    document.getElementById('modal').classList.add('active');
                    // ì´ë¯¸ ì²˜ë¦¬í–ˆìŒì„ í‘œì‹œ
                    sessionStorage.setItem('urlParamsProcessed', 'true');
                }, 300);
            }
        }

        // ì„œë²„ì— ë°ì´í„° ë™ê¸°í™” (ë¹„ë™ê¸°, ì˜¤ë¥˜ ë¬´ì‹œ)
        async function syncToServer(data, isUpdate = false) {
            try {
                const url = isUpdate && data.id ? `/api/loan-review-data/${data.id}` : '/api/loan-review-data';
                const method = isUpdate && data.id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('ì„œë²„ ë™ê¸°í™” ì„±ê³µ:', result);
                    // ì„œë²„ì—ì„œ ë°˜í™˜í•œ IDë¡œ ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    if (result.id && !data.id) {
                        data.id = result.id;
                    }
                    return result;
                } else {
                    console.warn('ì„œë²„ ë™ê¸°í™” ì‹¤íŒ¨:', response.status);
                }
            } catch (error) {
                console.warn('ì„œë²„ ë™ê¸°í™” ì˜¤ë¥˜ (ë¬´ì‹œë¨):', error);
            }
            return null;
        }
        
        // ë°ì´í„° ì €ì¥ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function saveData(event) {
            event.preventDefault();

            const editIndex = document.getElementById('editIndex').value;
            const newStatus = document.getElementById('status').value;
            const creditCheckSelect = document.getElementById('creditCheckDate').value;
            const newData = {
                customerName: document.getElementById('customerName').value,
                phone: document.getElementById('phone').value,
                birthDate: document.getElementById('birthDate').value,
                collateralType: 'ì•„íŒŒíŠ¸',
                collateralValue: parseInt(document.getElementById('collateralValue').value) || null,
                loanAmount: parseInt(document.getElementById('loanAmount').value) || null,
                status: newStatus,
                creditCheckDate: creditCheckSelect === 'yes' ? 'yes' : '',
                contractScheduleDate: document.getElementById('contractScheduleDate').value,
                contractCompleteDate: document.getElementById('contractCompleteDate').value,
                remitDate: document.getElementById('remitDate').value,
                manager: document.getElementById('manager').value
            };

            if (editIndex) {
                // ê¸°ì¡´ ë°ì´í„°ì¸ ê²½ìš° ìƒíƒœ ë³€ê²½ ê¸°ë¡
                const memoHistory = allData[editIndex].memoHistory || [];
                const statusHistory = allData[editIndex].statusHistory || [];

                if (allData[editIndex].status !== newStatus) {
                    statusHistory.push({
                        status: newStatus,
                        date: new Date().toISOString(),
                        previousStatus: allData[editIndex].status
                    });
                }

                // ID ìœ ì§€
                newData.id = allData[editIndex].id;
                allData[editIndex] = newData;
                allData[editIndex].statusHistory = statusHistory;
                allData[editIndex].memoHistory = memoHistory;

                if (!allData[editIndex].statusHistory || allData[editIndex].statusHistory.length === 0) {
                    allData[editIndex].statusHistory = [{status: newStatus, date: new Date().toISOString()}];
                }
            } else {
                newData.statusHistory = [{status: newStatus, date: new Date().toISOString()}];
                newData.memoHistory = [];
                allData.push(newData);
            }

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™” (ì˜¤ë¥˜ëŠ” ë¬´ì‹œ)
            const dataToSync = editIndex ? allData[editIndex] : allData[allData.length - 1];
            syncToServer(dataToSync, !!editIndex);

            closeModal();
            renderTable();
            updateSummary();
        }

        // ìƒíƒœ ë³€ê²½ í•¨ìˆ˜ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function changeStatus(index, newStatus) {
            const oldStatus = allData[index].status;
            if (oldStatus === newStatus) return;

            allData[index].status = newStatus;

            // í•´ë‹¹ ìƒíƒœì˜ ë‚ ì§œ í•„ë“œ ìë™ ê¸°ë¡
            if (statusDateMapping[newStatus]) {
                const today = new Date().toISOString().split('T')[0];
                allData[index][statusDateMapping[newStatus]] = today;
            }

            if (!allData[index].statusHistory) {
                allData[index].statusHistory = [];
            }
            if (!allData[index].memoHistory) {
                allData[index].memoHistory = [];
            }

            allData[index].statusHistory.push({
                status: newStatus,
                date: new Date().toISOString(),
                previousStatus: oldStatus
            });

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
            syncToServer(allData[index], true);

            renderTable();
            updateSummary();
        }

        // ë“œë¡­ë‹¤ìš´ ì„ íƒìœ¼ë¡œ ìƒíƒœ ë³€ê²½
        function changeStatusFromSelect(index, newStatus) {
            const selectElement = document.getElementById(`status-${index}`);
            const oldStatus = allData[index].status;

            if (oldStatus === newStatus) return;

            changeStatus(index, newStatus);
        }

        // ìƒíƒœ ë³€ê²½ íˆìŠ¤í† ë¦¬ ë³´ê¸°
        function showStatusHistory(index) {
            const data = allData[index];
            const history = data.statusHistory || [];

            let historyHTML = `<h3>${data.customerName} (${data.phone}) - ìƒíƒœ ë³€ê²½ íˆìŠ¤í† ë¦¬</h3>`;
            historyHTML += '<table style="width:100%; border-collapse: collapse; margin-top: 15px;">';
            historyHTML += '<tr style="background: #f0f0f0;"><th style="padding:8px; border: 1px solid #ddd;">ìˆœë²ˆ</th><th style="padding:8px; border: 1px solid #ddd;">ìƒíƒœ</th><th style="padding:8px; border: 1px solid #ddd;">ë³€ê²½ ì‹œê°„</th></tr>';

            history.forEach((record, idx) => {
                const date = new Date(record.date).toLocaleString('ko-KR');
                historyHTML += `<tr><td style="padding:8px; border: 1px solid #ddd; text-align:center;">${idx + 1}</td><td style="padding:8px; border: 1px solid #ddd;"><span class="status ${record.status}">${record.status}</span></td><td style="padding:8px; border: 1px solid #ddd;">${date}</td></tr>`;
            });

            historyHTML += '</table>';

            const modalId = 'popup-' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'popup-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="closePopupModal('${modalId}')">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        ${historyHTML}
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-primary" onclick="closePopupModal('${modalId}')">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').appendChild(modal);
        }

        // ì§„í–‰ íƒ€ì„ë¼ì¸ ë³´ê¸°
        function showProgressTimeline(index) {
            const data = allData[index];

            let timelineHTML = `<h3>${data.customerName} (${data.phone}) - ì§„í–‰ íƒ€ì„ë¼ì¸</h3>`;
            timelineHTML += '<div style="margin-top: 20px;">';

            const timelineEvents = [];

            // ì „ì²´ ìƒíƒœ íë¦„ê³¼ ë‚ ì§œ ìˆ˜ì§‘
            statusFlow.forEach(status => {
                const dateField = statusDateMapping[status];
                let eventDate = dateField ? data[dateField] : null;

                // íˆìŠ¤í† ë¦¬ì—ì„œ ì •í™•í•œ ë³€ê²½ ì‹œê°„ ì°¾ê¸°
                const historyRecord = (data.statusHistory || []).find(h => h.status === status);
                const changeTime = historyRecord ? new Date(historyRecord.date).toLocaleString('ko-KR') : null;

                if (changeTime) {
                    timelineEvents.push({
                        status: status,
                        date: eventDate || changeTime.split(' ')[0],
                        time: changeTime
                    });
                }
            });

            if (timelineEvents.length === 0) {
                timelineHTML += '<p style="color: #999;">ì•„ì§ ì§„í–‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                timelineHTML += '<style>';
                timelineHTML += '.timeline { position: relative; padding: 20px 0; }';
                timelineHTML += '.timeline-item { margin-bottom: 25px; padding-left: 50px; position: relative; }';
                timelineHTML += '.timeline-dot { position: absolute; left: 5px; top: 5px; width: 20px; height: 20px; background: #2a5298; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 3px #2a5298; }';
                timelineHTML += '.timeline-line { position: absolute; left: 14px; top: 25px; width: 2px; height: calc(100% + 10px); background: #ddd; }';
                timelineHTML += '.timeline-item:last-child .timeline-line { display: none; }';
                timelineHTML += '.timeline-content { background: #f9f9f9; padding: 12px; border-radius: 4px; border-left: 3px solid #2a5298; }';
                timelineHTML += '.timeline-status { font-weight: 700; color: #2a5298; margin-bottom: 5px; }';
                timelineHTML += '.timeline-date { font-size: 12px; color: #999; }';
                timelineHTML += '</style>';
                timelineHTML += '<div class="timeline">';

                timelineEvents.forEach((event, idx) => {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-line"></div>
                            <div class="timeline-content">
                                <div class="timeline-status">${idx + 1}. ${event.status}</div>
                                <div class="timeline-date">ë‚ ì§œ: ${event.date}</div>
                                <div class="timeline-date">ì‹œê°„: ${event.time}</div>
                            </div>
                        </div>
                    `;
                });

                timelineHTML += '</div>';

                // ì†Œìš” ì‹œê°„ ê³„ì‚°
                if (timelineEvents.length > 1) {
                    const startDate = new Date(timelineEvents[0].date);
                    const endDate = new Date(timelineEvents[timelineEvents.length - 1].date);
                    const daysSpent = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));

                    timelineHTML += `<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 4px;">
                        <strong style="color: #2e7d32;">ì´ ì†Œìš”ì¼ìˆ˜: ${daysSpent}ì¼</strong>
                    </div>`;
                }
            }

            timelineHTML += '</div>';

            const modalId = 'popup-' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'popup-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="closePopupModal('${modalId}')">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        ${timelineHTML}
                        <div style="margin-top: 20px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closePopupModal('${modalId}'); showStatusHistory(${index})">íˆìŠ¤í† ë¦¬</button>
                            <button class="btn btn-primary" onclick="closePopupModal('${modalId}')">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').appendChild(modal);
        }

        // í–‰ ì„ íƒ í† ê¸€
        function toggleRowSelection(index) {
            if (selectedRows.has(index)) {
                selectedRows.delete(index);
            } else {
                selectedRows.add(index);
            }
            updateBulkControls();
            renderTable();
        }

        // ì¼ê´„ ì¡°ì‘ UI ì—…ë°ì´íŠ¸
        function updateBulkControls() {
            const bulkControls = document.getElementById('bulkControls');
            const selectedCount = document.getElementById('selectedCount');

            if (selectedRows.size > 0) {
                bulkControls.style.display = 'flex';
                selectedCount.innerText = `ì„ íƒë¨: ${selectedRows.size}ê°œ`;
            } else {
                bulkControls.style.display = 'none';
            }
        }

        // ì¼ê´„ ìƒíƒœ ë³€ê²½ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function bulkChangeStatus(newStatus) {
            if (selectedRows.size === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`${selectedRows.size}ê°œ í•­ëª©ì„ ${newStatus}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const indices = Array.from(selectedRows);
            const syncPromises = [];

            indices.forEach(index => {
                const oldStatus = allData[index].status;
                if (oldStatus !== newStatus) {
                    allData[index].status = newStatus;

                    // í•´ë‹¹ ìƒíƒœì˜ ë‚ ì§œ í•„ë“œ ìë™ ê¸°ë¡
                    if (statusDateMapping[newStatus]) {
                        const today = new Date().toISOString().split('T')[0];
                        allData[index][statusDateMapping[newStatus]] = today;
                    }

                    if (!allData[index].statusHistory) {
                        allData[index].statusHistory = [];
                    }
                    if (!allData[index].memoHistory) {
                        allData[index].memoHistory = [];
                    }

                    allData[index].statusHistory.push({
                        status: newStatus,
                        date: new Date().toISOString(),
                        previousStatus: oldStatus
                    });

                    // ì„œë²„ ë™ê¸°í™” ì¶”ê°€
                    syncPromises.push(syncToServer(allData[index], true));
                }
            });

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
            Promise.all(syncPromises);

            selectedRows.clear();
            renderTable();
            updateSummary();
            updateBulkControls();
        }

        // ëª¨ë‘ ì„ íƒ/í•´ì œ
        function toggleSelectAll() {
            const tbody = document.getElementById('tbody');
            if (selectedRows.size === tbody.children.length) {
                selectedRows.clear();
            } else {
                selectedRows.clear();
                for (let i = 0; i < allData.length; i++) {
                    selectedRows.add(i);
                }
            }
            renderTable();
        }
        
        // í…Œì´ë¸” ë Œë”ë§
        function renderTable(dataToRender = allData) {
            const tbody = document.getElementById('tbody');
            const emptyMessage = document.getElementById('emptyMessage');

            tbody.innerHTML = '';

            if (dataToRender.length === 0) {
                emptyMessage.style.display = 'block';
                return;
            }

            emptyMessage.style.display = 'none';

            dataToRender.forEach((data, filterIndex) => {
                const actualIndex = allData.indexOf(data);
                const row = tbody.insertRow();
                const isSelected = selectedRows.has(actualIndex);
                row.style.backgroundColor = isSelected ? '#e3f2fd' : '';

                let statusButtonsHTML = '';
                const currentStatusIndex = statusFlow.indexOf(data.status);

                // ë‹¤ìŒ ìƒíƒœë¡œ ë¹ ë¥´ê²Œ ë³€ê²½í•˜ëŠ” ë²„íŠ¼ë“¤
                for (let i = 0; i < Math.min(3, statusFlow.length - currentStatusIndex - 1); i++) {
                    const nextStatus = statusFlow[currentStatusIndex + i + 1];
                    const btnColor = i === 0 ? '#4CAF50' : (i === 1 ? '#2196F3' : '#FF9800');
                    statusButtonsHTML += `<button style="padding: 3px 6px; font-size: 11px; margin-right: 2px; background: ${btnColor}; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="changeStatus(${actualIndex}, '${nextStatus}')">â†’${nextStatus.substring(0, 3)}</button>`;
                }

                row.innerHTML = `
                    <td><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleRowSelection(${actualIndex})" style="cursor: pointer; width: 18px; height: 18px;"></td>
                    <td>${filterIndex + 1}</td>
                    <td><strong style="cursor: pointer; color: #2a5298; text-decoration: underline;" onclick="editData(${actualIndex})" title="í´ë¦­í•˜ì—¬ ìˆ˜ì •">${data.customerName}</strong></td>
                    <td>${data.phone}</td>
                    <td>${data.birthDate || '-'}</td>
                    <td class="amount">${data.collateralValue ? parseInt(data.collateralValue).toLocaleString() + 'ë§Œì›' : '-'}</td>
                    <td class="amount">${data.loanAmount ? parseInt(data.loanAmount).toLocaleString() + 'ë§Œì›' : '-'}</td>
                    <td>
                        <select id="status-${actualIndex}" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; background: white; font-size: 13px; cursor: pointer;" onchange="changeStatusFromSelect(${actualIndex}, this.value)">
                            <option value="${data.status}" selected style="background: white; color: black;">${data.status}</option>
                            ${statusFlow.map(s => s !== data.status ? `<option value="${s}">${s}</option>` : '').join('')}
                            ${data.status !== 'ë°˜ë ¤' ? '<option value="ë°˜ë ¤">ë°˜ë ¤</option>' : ''}
                        </select>
                        <div style="margin-top: 5px; display: flex; gap: 5px;">
                            <span style="cursor: pointer; color: #FF9800; text-decoration: underline; font-size: 11px; font-weight: 600;" onclick="showProgressTimeline(${actualIndex})" title="íƒ€ì„ë¼ì¸ ë³´ê¸°">ğŸ“Šíƒ€ì„ë¼ì¸</span>
                            <span style="cursor: pointer; color: #2196F3; text-decoration: underline; font-size: 11px;" onclick="showStatusHistory(${actualIndex})" title="íˆìŠ¤í† ë¦¬ ë³´ê¸°">ê¸°ë¡</span>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <button style="padding: 4px 8px; font-size: 12px; background: ${data.creditCheckDate ? '#4CAF50' : '#ccc'}; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="toggleCreditCheck(${actualIndex})">${data.creditCheckDate ? 'âœ“' : 'âœ•'}</button>
                    </td>
                    <td style="text-align: center;">
                        <button style="padding: 4px 8px; font-size: 12px; background: ${data.contractScheduleDate ? '#2196F3' : '#e0e0e0'}; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="editDateField(${actualIndex}, 'contractScheduleDate', 'ìì„œì˜ˆì •ì¼')">${data.contractScheduleDate || '-'}</button>
                    </td>
                    <td style="text-align: center;">
                        <button style="padding: 4px 8px; font-size: 12px; background: ${data.contractCompleteDate ? '#FF9800' : '#e0e0e0'}; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="editDateField(${actualIndex}, 'contractCompleteDate', 'ìì„œì™„ë£Œì¼')">${data.contractCompleteDate || '-'}</button>
                    </td>
                    <td style="text-align: center;">
                        <button style="padding: 4px 8px; font-size: 12px; background: ${data.remitDate ? '#2e7d32' : '#e0e0e0'}; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="editDateField(${actualIndex}, 'remitDate', 'ì†¡ê¸ˆì¼')">${data.remitDate || '-'}</button>
                    </td>
                    <td>${data.manager || '-'}</td>
                    <td style="font-size: 11px;">
                        ${statusButtonsHTML}
                        <button style="padding: 3px 6px; font-size: 11px; margin-right: 2px; background: #FF6F00; color: white; border: none; border-radius: 3px; cursor: pointer;" onclick="showMemoModal(${actualIndex})">ğŸ“ë©”ëª¨</button>
                    </td>
                `;
            });

            updateBulkControls();
        }

        // ë°ì´í„° ìˆ˜ì •
        function editData(index) {
            const data = allData[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('customerName').value = data.customerName;
            document.getElementById('phone').value = data.phone;
            document.getElementById('birthDate').value = data.birthDate || '';
            document.getElementById('collateralValue').value = data.collateralValue;
            document.getElementById('loanAmount').value = data.loanAmount;
            document.getElementById('status').value = data.status;
            document.getElementById('creditCheckDate').value = data.creditCheckDate ? 'yes' : '';
            document.getElementById('contractScheduleDate').value = data.contractScheduleDate;
            document.getElementById('contractCompleteDate').value = data.contractCompleteDate;
            document.getElementById('remitDate').value = data.remitDate;
            document.getElementById('manager').value = data.manager;

            document.getElementById('modalTitle').innerText = 'ê³ ê° ì •ë³´ ìˆ˜ì •';
            document.getElementById('modal').classList.add('active');
        }

        // ì‹ ìš©ì¡°íšŒ í† ê¸€ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function toggleCreditCheck(index) {
            if (allData[index].creditCheckDate) {
                allData[index].creditCheckDate = '';
            } else {
                allData[index].creditCheckDate = 'yes';
            }

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
            syncToServer(allData[index], true);

            renderTable();
        }

        // ë‚ ì§œ í•„ë“œ í¸ì§‘ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function editDateField(index, fieldName, fieldLabel) {
            const currentValue = allData[index][fieldName] || '';
            const newDate = prompt(`${fieldLabel}ì„(ë¥¼) ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD í˜•ì‹):\ní˜„ì¬ê°’: ${currentValue}`, currentValue);

            if (newDate !== null && newDate !== '') {
                const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                if (!dateRegex.test(newDate)) {
                    alert('ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤ (YYYY-MM-DD)');
                    return;
                }
                allData[index][fieldName] = newDate;

                // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
                localStorage.setItem('loanReviewData', JSON.stringify(allData));

                // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
                syncToServer(allData[index], true);

                renderTable();
            } else if (newDate === '') {
                allData[index][fieldName] = '';

                // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
                localStorage.setItem('loanReviewData', JSON.stringify(allData));

                // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
                syncToServer(allData[index], true);

                renderTable();
            }
        }

        // íŒì—… ëª¨ë‹¬ ë‹«ê¸° (í†µí•© í•¨ìˆ˜)
        function closePopupModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // ëª¨ë‹¬ ë‹«ê¸° (ëª¨ë“  ë©”ëª¨ ëª¨ë‹¬) - í•˜ìœ„í˜¸í™˜ì„±ìš©
        function closeMemoModal() {
            const memoModals = document.querySelectorAll('[data-memo-modal="true"]');
            memoModals.forEach(modal => modal.remove());
        }

        // ë©”ëª¨ ëª¨ë‹¬ í‘œì‹œ
        function showMemoModal(index) {
            const data = allData[index];
            if (!data.memoHistory) {
                data.memoHistory = [];
            }

            let memoHTML = `<h3>${data.customerName} (${data.phone}) - ë©”ëª¨</h3>`;
            memoHTML += '<div style="margin-top: 20px;">';

            // ë©”ëª¨ ì…ë ¥ í¼
            memoHTML += `
                <div style="margin-bottom: 20px;">
                    <textarea id="memoInput-${index}" placeholder="ìƒˆë¡œìš´ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; min-height: 80px;"></textarea>
                    <button onclick="saveMemo(${index})" style="margin-top: 10px; padding: 10px 20px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">ì €ì¥</button>
                </div>
            `;

            // ë©”ëª¨ íˆìŠ¤í† ë¦¬
            memoHTML += '<h4 style="margin-top: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">ë©”ëª¨ íˆìŠ¤í† ë¦¬</h4>';

            if (data.memoHistory.length === 0) {
                memoHTML += '<p style="color: #999; text-align: center; padding: 20px;">ë“±ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                memoHTML += '<div style="max-height: 300px; overflow-y: auto;">';
                data.memoHistory.forEach((memo, idx) => {
                    const memoDate = new Date(memo.date).toLocaleString('ko-KR');
                    memoHTML += `
                        <div style="background: #f9f9f9; padding: 12px; margin-bottom: 10px; border-left: 4px solid #2a5298; border-radius: 4px;">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">${memoDate}</div>
                            <div style="color: #555; white-space: pre-wrap; line-height: 1.6;">${memo.text}</div>
                        </div>
                    `;
                });
                memoHTML += '</div>';
            }

            memoHTML += '</div>';

            const modalId = 'popup-' + Date.now();
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'popup-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;" onclick="closePopupModal('${modalId}')">
                    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        ${memoHTML}
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-primary" onclick="closePopupModal('${modalId}')">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').appendChild(modal);

            // í¬ì»¤ìŠ¤ ì„¤ì •
            setTimeout(() => {
                const textarea = document.getElementById('memoInput-' + index);
                if (textarea) textarea.focus();
            }, 100);
        }

        // ë©”ëª¨ ì €ì¥ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function saveMemo(index) {
            const memoText = document.getElementById('memoInput-' + index).value.trim();
            if (!memoText) {
                alert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!allData[index].memoHistory) {
                allData[index].memoHistory = [];
            }

            allData[index].memoHistory.push({
                text: memoText,
                date: new Date().toISOString()
            });

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ì— ë¹„ë™ê¸° ë™ê¸°í™”
            syncToServer(allData[index], true);

            // ë©”ëª¨ íˆìŠ¤í† ë¦¬ ìƒˆë¡œê³ ì¹¨
            showMemoModal(index);
        }

        // ì¼ê´„ ì‚­ì œ (ë¡œì»¬ + ì„œë²„ ë™ê¸°í™”)
        function bulkDelete() {
            if (selectedRows.size === 0) {
                alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!confirm(`${selectedRows.size}ê°œ í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            const indices = Array.from(selectedRows).sort((a, b) => b - a);
            const deletePromises = [];

            indices.forEach(index => {
                // ì„œë²„ì—ì„œ ì‚­ì œ (IDê°€ ìˆìœ¼ë©´)
                if (allData[index].id) {
                    deletePromises.push(
                        fetch(`/api/loan-review-data/${allData[index].id}`, { method: 'DELETE' })
                            .catch(e => console.warn('ì„œë²„ ì‚­ì œ ì‹¤íŒ¨:', e))
                    );
                }
                allData.splice(index, 1);
            });

            // 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
            localStorage.setItem('loanReviewData', JSON.stringify(allData));

            // 2. ì„œë²„ ì‚­ì œëŠ” ë¹„ë™ê¸°ë¡œ ì§„í–‰
            Promise.all(deletePromises);

            selectedRows.clear();
            renderTable();
            updateSummary();
            updateBulkControls();
        }
        
        // ê²€ìƒ‰
        function searchData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(data => 
                data.customerName.toLowerCase().includes(searchTerm) || 
                data.phone.includes(searchTerm)
            );
            renderTable(filtered);
        }
        
        // ëª¨ë‹¬ ì—´ê¸°
        function openAddModal() {
            document.getElementById('editIndex').value = '';
            document.getElementById('dataForm').reset();
            document.getElementById('modalTitle').innerText = 'ê³ ê° ì •ë³´ ì¶”ê°€';
            document.getElementById('modal').classList.add('active');
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateSummary() {
            const total = allData.length;
            const reviewing = allData.filter(d => ['ì ‘ìˆ˜', 'ì‹¬ì‚¬ì¤‘', 'ìì„œì˜ˆì •', 'ìì„œì™„ë£Œ'].includes(d.status)).length;
            const completed = allData.filter(d => d.status === 'ì†¡ê¸ˆ').length;
            const sent = allData.filter(d => ['ë³´ë¥˜', 'ì·¨ì†Œ'].includes(d.status)).length;

            document.getElementById('totalCount').innerText = total;
            document.getElementById('reviewingCount').innerText = reviewing;
            document.getElementById('completedCount').innerText = completed;
            document.getElementById('sentCount').innerText = sent;
        }
        
        // CSV ë‚´ë³´ë‚´ê¸°
        function exportData() {
            if (allData.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = ['No', 'ê³ ê°ëª…', 'íœ´ëŒ€í°', 'ì‹ ì²­ê¸ˆì•¡', 'ë‹´ë³´ì¢…ë¥˜', 'ë‹´ë³´í‰ê°€ì•¡', 'ì‹ ìš©ë“±ê¸‰', 'ì±„ë¬´ë¹„ìœ¨', 'ì›”ì†Œë“', 'ì§„í–‰ìƒíƒœ', 'ë‹´ë³´í‰ê°€í™•ì¸', 'ì‹ ìš©ì¡°íšŒ', 'ì„œë¥˜ë°œê¸‰', 'ìì„œì˜ˆì •', 'ìì„œì™„ë£Œ', 'ì†¡ê¸ˆ', 'ë‹´ë‹¹ì', 'ë¹„ê³ '];
            const rows = allData.map((data, index) => [
                index + 1,
                data.customerName,
                data.phone,
                data.loanAmount,
                data.collateralType,
                data.collateralValue,
                data.creditGrade,
                data.debtRatio,
                data.monthlyIncome,
                data.status,
                data.collateralConfirmDate,
                data.creditCheckDate,
                data.docIssueDate,
                data.contractScheduleDate,
                data.contractCompleteDate,
                data.remitDate,
                data.manager,
                data.notes
            ]);
            
            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ëŒ€ì¶œì‹¬ì‚¬_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('load', loadData);
        
        // ëª¨ë‹¬ ë°–ì„ í´ë¦­í•˜ë©´ ë‹«ê¸°
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
