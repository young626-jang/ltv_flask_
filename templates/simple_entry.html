<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¨ìˆœ LTV ê³„ì‚°ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f8f9fa; }
        .main-container { width: 100%; padding: 1rem; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; border-radius: 1rem; }
        .card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem 1rem 0 0 !important; }
        .upload-zone { border: 2px dashed #adb5bd; border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .upload-zone:hover { border-color: #0d6efd; background-color: #e9ecef; }
        .upload-zone.dragover { border-color: #0d6efd; background-color: #e9ecef; }
        #upload-section.dragover { border-color: #0d6efd; background-color: #e9ecef; }
        .ltv-checkbox { cursor: pointer; padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 0.5rem; margin: 0.25rem; }
        .ltv-checkbox:hover { background: #e9ecef; }
        .ltv-checkbox input:checked + label { color: #0d6efd; font-weight: bold; }
        .result-card { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; }
        #file-input { display: none; }
        .resize-handle {
            width: 10px;
            background: #dee2e6;
            cursor: col-resize;
            position: absolute;
            top: 0;
            right: -5px;
            height: 100%;
            z-index: 10;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        .resize-handle:hover {
            background: #0d6efd;
            width: 12px;
            right: -6px;
        }
        .resize-handle:before {
            content: 'â‹®â‹®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6c757d;
            font-size: 12px;
            letter-spacing: -2px;
        }
        .resizable-row {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="row resizable-row" style="display: flex; width: 100%;">
            <!-- ì™¼ìª½: PDF ë·°ì–´ & ì—…ë¡œë“œ -->
            <div id="pdf-column" class="col-lg-7" style="position: relative;">
                <!-- PDF ì—…ë¡œë“œ ì„¹ì…˜ -->
                <div id="upload-section" style="border: 2px dashed #adb5bd; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; text-align: center; height: 400px; cursor: pointer; transition: all 0.3s ease;">
                    <div class="text-center">
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <h4 class="mt-3">PDF íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­</h4>
                        <p class="text-muted">ë“±ê¸°ë¶€ë“±ë³¸ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì‹œë©´ ì£¼ìš” ì •ë³´ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                <input type="file" id="file-input" accept=".pdf" style="display: none;">
                
                <!-- PDF ë·°ì–´ ì„¹ì…˜ -->
                <div id="viewer-section" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> <span id="file-name-display"></span></h5>
                            <button class="btn btn-outline-light btn-sm" onclick="resetUpload()">
                                <i class="bi bi-arrow-clockwise"></i> ë‹¤ì‹œ ì—…ë¡œë“œ
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <iframe id="pdf-viewer" style="width: 100%; height: calc(100vh - 80px); border: none;"></iframe>
                        </div>
                    </div>
                </div>
                
                <!-- í¬ê¸° ì¡°ì ˆ í•¸ë“¤ -->
                <div class="resize-handle" id="resize-handle"></div>
            </div>

            <!-- ì˜¤ë¥¸ìª½: ì…ë ¥í¼ & ê²°ê³¼ -->
            <div id="form-column" class="col-lg-5">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> ê¸°ë³¸ ì •ë³´</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer-name" class="form-label">ê³ ê°ëª…</label>
                                <input type="text" class="form-control form-control-sm" id="customer-name" placeholder="PDFì—ì„œ ìë™ ì…ë ¥">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="area" class="form-label">ë©´ì  (ã¡)</label>
                                <input type="text" class="form-control form-control-sm" id="area" placeholder="PDFì—ì„œ ìë™ ì…ë ¥">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">ì£¼ì†Œ</label>
                            <input type="text" class="form-control form-control-sm" id="address" placeholder="PDFì—ì„œ ìë™ ì…ë ¥">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="kb-price" class="form-label">KBì‹œì„¸ (ë§Œì›) *</label>
                                <input type="number" class="form-control form-control-sm" id="kb-price" placeholder="ì˜ˆ: 50000" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="deduction-amount" class="form-label">ë°©ê³µì œ (ë§Œì›)</label>
                                <input type="number" class="form-control form-control-sm" id="deduction-amount" placeholder="ì˜ˆ: 2800" value="2500">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="region-select" class="form-label">ë°©ê³µì œ ì§€ì—­ ì„ íƒ</label>
                            <select class="form-select form-select-sm" id="region-select" onchange="updateDeduction()">
                                {% for region, amount in region_map.items() %}
                                <option value="{{ amount }}">{{ region }} ({{ amount }}ë§Œì›)</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LTV ë¹„ìœ¨ ì…ë ¥ (%)</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" id="ltv-rate-1" placeholder="ì˜ˆ: 80" min="1" max="100" value="80">
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control form-control-sm" id="ltv-rate-2" placeholder="ì˜ˆ: 70" min="1" max="100">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ëŒ€ì¶œ ì •ë³´ -->
                <!-- ëŒ€ì¶œ ì •ë³´ -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-credit-card"></i> ëŒ€ì¶œ ì •ë³´</h5>
                        <button class="btn btn-light btn-sm" onclick="addLoanItem()">
                            <i class="bi bi-plus"></i> ì¶”ê°€
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="loan-items">
                            <!-- ëŒ€ì¶œ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </div>
                        <button class="btn btn-success w-100 mt-3" onclick="calculateLTV()">
                            <i class="bi bi-calculator"></i> LTV ê³„ì‚°í•˜ê¸°
                        </button>
                        <div id="calc-status" class="mt-2"></div>
                    </div>
                </div>

                <!-- ê³„ì‚° ê²°ê³¼ -->
                <div class="card result-card" id="result-card" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-graph-up"></i> ê³„ì‚° ê²°ê³¼</h5>
                    </div>
                    <div class="card-body">
                        <div id="ltv-results">
                            <!-- ê³„ì‚° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let loanCounter = 0;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ëŒ€ì¶œ í•­ëª© ì¶”ê°€
        document.addEventListener('DOMContentLoaded', function() {
            addLoanItem();
            setupDragAndDrop();
            setupResizer();
        });

        // PDF ì—…ë¡œë“œ ì„¤ì •
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('upload-section');
            const fileInput = document.getElementById('file-input');
            
            // í´ë¦­ ì´ë²¤íŠ¸
            uploadSection.addEventListener('click', function() {
                fileInput.click();
            });
            
            // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸  
            fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ë“¤
            uploadSection.addEventListener('dragenter', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragover');
            });
            
            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
            });
            
            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                        handleFileUpload(file);
                    }
                }
            });
        }
        
        // í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥
        function setupResizer() {
            const resizeHandle = document.getElementById('resize-handle');
            const pdfColumn = document.getElementById('pdf-column');
            const formColumn = document.getElementById('form-column');
            const container = document.querySelector('.main-container');
            let isResizing = false;
            let startX = 0;
            let startLeftWidth = 0;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startX = e.clientX;
                
                const containerRect = container.getBoundingClientRect();
                const pdfRect = pdfColumn.getBoundingClientRect();
                startLeftWidth = ((pdfRect.width / containerRect.width) * 100);
                
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = container.getBoundingClientRect();
                const deltaX = e.clientX - startX;
                const deltaPercent = (deltaX / containerRect.width) * 100;
                const newLeftWidth = startLeftWidth + deltaPercent;
                
                // ìµœì†Œ/ìµœëŒ€ í¬ê¸° ì œí•œ (25% ~ 85%)
                if (newLeftWidth >= 25 && newLeftWidth <= 85) {
                    const rightWidth = 100 - newLeftWidth;
                    
                    // Bootstrap í´ë˜ìŠ¤ ì œê±°
                    pdfColumn.className = pdfColumn.className.replace(/col-lg-\d+/, '').trim();
                    formColumn.className = formColumn.className.replace(/col-lg-\d+/, '').trim();
                    
                    // flex ì†ì„± ì‚¬ìš©ìœ¼ë¡œ ë” ì •í™•í•œ í¬ê¸° ì¡°ì ˆ
                    pdfColumn.style.flex = `0 0 ${newLeftWidth}%`;
                    formColumn.style.flex = `0 0 ${rightWidth}%`;
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        }
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('pdf_file', file);

            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const scraped = data.scraped_data;
                    
                    // ì¶”ì¶œëœ ì •ë³´ë¥¼ í¼ì— ì…ë ¥
                    if (scraped.customer_name) {
                        document.getElementById('customer-name').value = scraped.customer_name;
                    }
                    if (scraped.address) {
                        document.getElementById('address').value = scraped.address;
                    }
                    if (scraped.area) {
                        document.getElementById('area').value = scraped.area;
                    }
                    
                    // PDF ë·°ì–´ í‘œì‹œ
                    document.getElementById('file-name-display').textContent = file.name;
                    document.getElementById('pdf-viewer').src = `/view_pdf/${data.filename}`;
                    
                    // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê³  ë·°ì–´ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('upload-section').style.display = 'none';
                    document.getElementById('viewer-section').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('PDF ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ì—…ë¡œë“œ ë¦¬ì…‹
        function resetUpload() {
            document.getElementById('upload-section').style.display = 'flex';
            document.getElementById('viewer-section').style.display = 'none';
            document.getElementById('file-input').value = '';
            
            // ì›ë˜ í¬ê¸°ë¡œ ë³µì›
            const pdfColumn = document.getElementById('pdf-column');
            const formColumn = document.getElementById('form-column');
            
            pdfColumn.className = 'col-lg-7';
            pdfColumn.style.flex = '';
            pdfColumn.style.width = '';
            formColumn.className = 'col-lg-5';
            formColumn.style.flex = '';
            formColumn.style.width = '';
            formColumn.style.display = 'block';
        }


        // ëŒ€ì¶œ í•­ëª© ì¶”ê°€
        function addLoanItem() {
            loanCounter++;
            const loanItems = document.getElementById('loan-items');
            
            const loanItem = document.createElement('div');
            loanItem.className = 'border rounded p-3 mb-3';
            loanItem.id = `loan-${loanCounter}`;
            
            loanItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">ëŒ€ì¶œ ${loanCounter}</h6>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLoanItem(${loanCounter})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label class="form-label">ëŒ€ì¶œê¸°ê´€</label>
                        <input type="text" class="form-control form-control-sm" name="lender" placeholder="ëŒ€ì¶œê¸°ê´€ëª…">
                    </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">ì±„ê¶Œìµœê³ ì•¡ (ë§Œì›)</label>
                        <input type="number" class="form-control form-control-sm" name="max-amount" placeholder="ì±„ê¶Œìµœê³ ì•¡" onchange="calculatePrincipal(${loanCounter})">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">ë¹„ìœ¨ (%)</label>
                        <input type="number" class="form-control form-control-sm" name="ratio" value="100" min="1" max="200" onchange="calculatePrincipal(${loanCounter})">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">ì›ê¸ˆ (ë§Œì›)</label>
                        <input type="number" class="form-control form-control-sm" name="principal" placeholder="ìë™ê³„ì‚°">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">ìƒíƒœ</label>
                        <select class="form-select form-select-sm" name="status">
                            <option value="ëŒ€í™˜">ëŒ€í™˜</option>
                            <option value="ì„ ë§ì†Œ">ì„ ë§ì†Œ</option>
                            <option value="í‡´ê±°ìê¸ˆ">í‡´ê±°ìê¸ˆ</option>
                            <option value="ìœ ì§€">ìœ ì§€</option>
                            <option value="ë™ì˜">ë™ì˜</option>
                            <option value="ë¹„ë™ì˜">ë¹„ë™ì˜</option>
                        </select>
                    </div>
                </div>
            `;
            
            loanItems.appendChild(loanItem);
        }

        // ëŒ€ì¶œ í•­ëª© ì œê±°
        function removeLoanItem(id) {
            const loanItem = document.getElementById(`loan-${id}`);
            if (loanItem) {
                loanItem.remove();
            }
        }

        // ì›ê¸ˆ ìë™ ê³„ì‚°
        function calculatePrincipal(loanId) {
            const loanItem = document.getElementById(`loan-${loanId}`);
            const maxAmount = loanItem.querySelector('input[name="max-amount"]').value;
            const ratio = loanItem.querySelector('input[name="ratio"]').value;
            
            if (maxAmount && ratio) {
                fetch('/api/calculate_principal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        max_amount: parseFloat(maxAmount) || 0,
                        ratio: parseFloat(ratio) || 100
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loanItem.querySelector('input[name="principal"]').value = data.principal;
                    }
                })
                .catch(error => {
                    console.error('ì›ê¸ˆ ê³„ì‚° ì˜¤ë¥˜:', error);
                });
            }
        }

        // LTV ê³„ì‚°
        function calculateLTV() {
            const inputs = {
                customer_name: document.getElementById('customer-name').value,
                address: document.getElementById('address').value,
                area: document.getElementById('area').value,
                kb_price: document.getElementById('kb-price').value,
                deduction_amount: document.getElementById('deduction-amount').value,
                ltv_rates: [
                    document.getElementById('ltv-rate-1').value,
                    document.getElementById('ltv-rate-2').value
                ].filter(rate => rate && parseInt(rate) > 0)
            };

            const loans = [];
            document.querySelectorAll('[id^="loan-"]').forEach(item => {
                loans.push({
                    lender: item.querySelector('input[name="lender"]').value,
                    max_amount: item.querySelector('input[name="max-amount"]').value,
                    ratio: item.querySelector('input[name="ratio"]').value,
                    principal: item.querySelector('input[name="principal"]').value,
                    status: item.querySelector('select[name="status"]').value
                });
            });

            if (inputs.ltv_rates.length === 0) {
                showStatus('calc-status', 'âŒ LTV ë¹„ìœ¨ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            if (!inputs.kb_price) {
                showStatus('calc-status', 'âŒ KBì‹œì„¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }

            showStatus('calc-status', 'ğŸ”„ LTV ê³„ì‚° ì¤‘...', 'info');

            fetch('/api/generate_text_memo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    inputs: inputs,
                    loans: loans,
                    fees: {}
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.memo) {
                    displayResults(data.memo, inputs.ltv_rates);
                    showStatus('calc-status', 'âœ… ê³„ì‚° ì™„ë£Œ!', 'success');
                    document.getElementById('result-card').style.display = 'block';
                } else {
                    showStatus('calc-status', 'âŒ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            })
            .catch(error => {
                showStatus('calc-status', 'âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            });
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(memo, ltvRates) {
            const resultsDiv = document.getElementById('ltv-results');
            
            // ë©”ëª¨ì—ì„œ LTV ì •ë³´ ì¶”ì¶œí•˜ì—¬ ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œ
            const lines = memo.split('\n');
            let ltvResults = [];
            
            lines.forEach(line => {
                if (line.includes('LTV') && line.includes('%') && line.includes('í•œë„')) {
                    ltvResults.push(line.trim());
                }
            });

            let resultsHTML = '';
            if (ltvResults.length > 0) {
                ltvResults.forEach(result => {
                    resultsHTML += `<p class="mb-2"><strong>${result}</strong></p>`;
                });
            } else {
                resultsHTML = `<pre class="text-white">${memo}</pre>`;
            }
            
            resultsDiv.innerHTML = resultsHTML;
        }

        // ë°©ê³µì œ ì§€ì—­ ì„ íƒ ì‹œ ìë™ ì—…ë°ì´íŠ¸
        function updateDeduction() {
            const regionSelect = document.getElementById('region-select');
            const deductionInput = document.getElementById('deduction-amount');
            deductionInput.value = regionSelect.value;
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type} alert-sm mb-0">${message}</div>`;
        }
    </script>
</body>
</html>