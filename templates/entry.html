<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <title>LTV ê³„ì‚°ê¸° ë§Œë“ ì´ ì¥ì„œì˜</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/69/69524.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="manifest" href="/static/manifest.json">

    <style>
        html, body { 
            height: 100%; 
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'Malgun Gothic', sans-serif; 
        }
        
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .main-container { 
            display: flex; 
            height: 100vh; 
            padding: 1rem; 
            gap: 1rem; 
        }
        .pdf-viewer-column { flex: 2.5; display: flex; flex-direction: column; }
        .form-column { flex: 1.5; height: calc(100vh - 2rem); overflow-y: auto; padding-right: 15px; }
        .pdf-iframe-container { flex-grow: 1; position: relative; }
        #pdf-viewer { width: 100%; height: 100%; border: 1px solid #dee2e6; border-radius: 0.5rem; }
        #upload-section { border: 2px dashed #adb5bd; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; text-align: center; height: 100%; cursor: pointer; transition: all 0.3s ease; }
        #upload-section.dragover { border-color: #0d6efd; background-color: #e9ecef; }
        #file-input { display: none; }
        body { font-size: 0.9rem; }
        label { font-weight: 500; margin-bottom: 0.25rem; }
        #loan-tab-pane .loan-item {padding: 0px;}

        /* âœ¨ ìˆœì„œ ì¡°ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .order-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: center;
        }
        
        .order-btn {
            width: 24px;
            height: 20px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: #6c757d;
            transition: all 0.2s ease;
        }
        
        .order-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
        }
        
        .order-btn:active {
            transform: scale(0.95);
        }
        
        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ê°€ë¡œ ëª¨ë“œ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        .main-container.horizontal-mode { flex-direction: column; }
        .main-container.horizontal-mode .pdf-viewer-column { width: 100%; flex: 0 0 45vh; }
        .main-container.horizontal-mode .form-column { width: 100%; flex: 1; max-height: 50vh; }
        .main-container.horizontal-mode #pdf-viewer { height: 40vh; }

        /* ============= ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• ê°œì„  ============= */
        
        /* íƒœë¸”ë¦¿ (768px ì´í•˜) */
        @media (max-width: 768px) {
            body {
                font-size: 0.85rem;
            }
            
            .main-container {
                flex-direction: column;
                padding: 0.5rem;
                gap: 0.5rem;
                height: 100vh;
            }
            
            .pdf-viewer-column {
                flex: 0 0 40vh;
                min-height: 250px;
            }
            
            .form-column {
                flex: 1;
                height: auto;
                max-height: none;
                padding-right: 0;
                overflow-y: auto;
            }
            
            /* ë²„íŠ¼ë“¤ì„ í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ í¬ê²Œ */
            .btn {
                min-height: 44px; /* ì• í”Œ ê°€ì´ë“œë¼ì¸ 44px */
                font-size: 0.9rem;
            }
            
            .btn-sm {
                min-height: 38px;
                font-size: 0.8rem;
            }
            
            /* ì…ë ¥ í•„ë“œë“¤ì„ í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ */
            .form-control, .form-select {
                min-height: 44px;
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
            
            .form-control-sm, .form-select-sm {
                min-height: 38px;
                font-size: 14px;
            }
            
            /* ìˆœì„œ ì¡°ì • ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
            .order-btn {
                width: 28px;
                height: 24px;
                font-size: 12px;
            }
            
            /* ëŒ€ì¶œ í•­ëª© ëª¨ë°”ì¼ ìµœì í™” */
            .loan-item {
                flex-direction: column !important;
                gap: 0.5rem !important;
                padding: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                background: #f8f9fa;
            }
            
            .loan-item > div {
                flex: none !important;
                width: 100% !important;
            }
            
            /* ì—…ë¡œë“œ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            #upload-section {
                min-height: 200px;
                padding: 1rem;
            }
            
            #upload-section h4 {
                font-size: 1.2rem;
            }
            
            /* í…ìŠ¤íŠ¸ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            #generated-memo {
                min-height: 300px;
                font-size: 0.85rem;
            }
            
            /* íƒ­ ë²„íŠ¼ë“¤ ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .nav-tabs .nav-link {
                white-space: nowrap;
                min-width: 80px;
            }
        }
        
        /* ëª¨ë°”ì¼ (576px ì´í•˜) */
        @media (max-width: 576px) {
            body {
                font-size: 0.8rem;
            }
            
            .main-container {
                padding: 0.25rem;
            }
            
            .pdf-viewer-column {
                flex: 0 0 35vh;
                min-height: 200px;
            }
            
            /* ë” ì‘ì€ í™”ë©´ì—ì„œëŠ” ë²„íŠ¼ë“¤ì„ ì„¸ë¡œë¡œ */
            .d-grid.gap-2.d-md-flex {
                display: flex !important;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .d-grid.gap-2.d-md-flex .btn {
                width: 100%;
                margin: 0;
            }
            
            /* ê³ ê° ì„ íƒ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            .input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .input-group .form-select,
            .input-group .btn {
                width: 100%;
                border-radius: 0.375rem !important;
            }
            
            /* ë§í¬ ë²„íŠ¼ë“¤ ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ë°°ì¹˜ */
            .btn-group.w-100 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .btn-group.w-100 .btn {
                border-radius: 0.375rem !important;
            }
            
            /* ëŒ€ì¶œ í•­ëª© í—¤ë” ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ì—ì„œëŠ” ë¼ë²¨ë¡œ ëŒ€ì²´) */
            .loan-tab-pane .d-flex.border-bottom {
                display: none !important;
            }
            
            /* í¼ í–‰ë“¤ ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ë°°ì¹˜ */
            .row.g-2 {
                --bs-gutter-x: 0;
            }
            
            .row.g-2 > [class*="col-"] {
                margin-bottom: 0.5rem;
            }
        }
        
        /* ì•„ì£¼ ì‘ì€ í™”ë©´ (400px ì´í•˜) */
        @media (max-width: 400px) {
            .main-container {
                padding: 0.125rem;
            }
            
            body {
                font-size: 0.75rem;
            }
            
            .btn {
                min-height: 40px;
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .form-control, .form-select {
                min-height: 40px;
                font-size: 14px;
            }
        }
        
        /* ê°€ë¡œëª¨ë“œ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-container {
                flex-direction: row;
            }
            
            .pdf-viewer-column {
                flex: 0 0 45%;
            }
            
            .form-column {
                flex: 1;
                height: calc(100vh - 1rem);
            }
        }
        
        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ í˜¸ë²„ íš¨ê³¼ ì œê±° */
            .btn:hover {
                transform: none;
            }
            
            /* í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€ */
            .btn:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            
            /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼) */
            .form-column::-webkit-scrollbar {
                width: 3px;
            }
            
            .form-column::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .form-column::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
            }
        }
        
        /* PWA ìƒíƒœë°” ê³ ë ¤ (iOS Safari) */
        @supports (padding-top: env(safe-area-inset-top)) {
            .main-container {
                padding-top: max(1rem, env(safe-area-inset-top));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }
        
        /* ëª¨ë°”ì¼ìš© ëŒ€ì¶œ í•­ëª© ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .mobile-label {
            display: none;
        }
        
        @media (max-width: 576px) {
            .mobile-label {
                display: block !important;
                font-weight: 600;
                margin-bottom: 0.25rem;
                color: #495057;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-light">

<div class="main-container" id="main-layout-wrapper">
    <div class="pdf-viewer-column" id="pdf-column">
        <div id="upload-section">
            <div>
                <i class="bi bi-cloud-arrow-up-fill" style="font-size: 4rem; color: #6c757d;"></i>
                <h4 class="mt-3">PDF íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­</h4>
                <p class="text-muted" id="upload-text">ë“±ê¸°ë¶€ë“±ë³¸ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì‹œë©´ ì£¼ìš” ì •ë³´ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                <div id="upload-spinner" class="spinner-border mt-3" role="status" style="display: none;"></div>
            </div>
        </div>
        <input type="file" id="file-input" accept=".pdf">
        <div id="viewer-section" style="display: none;" class="h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-shrink-0">
                <h4 id="file-name-display" class="mb-0 small text-muted"></h4>
                <button id="layout-toggle-btn" class="btn btn-outline-dark btn-sm"><i class="bi bi-distribute-horizontal"></i> ê°€ë¡œ ëª¨ë“œ</button>
            </div>
            <div class="pdf-iframe-container"><iframe id="pdf-viewer"></iframe></div>
        </div>
    </div>

    <div class="form-column" id="form-column-wrapper">
        <div class="p-2">
            <div class="input-group mb-3">
                <select class="form-select" id="customer-history"><option value="" selected>ê¸°ì¡´ ê³ ê° ë¶ˆëŸ¬ì˜¤ê¸°...</option></select>
                <button class="btn btn-outline-primary" id="load-customer-btn" type="button">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="btn btn-outline-danger" id="delete-customer-btn" type="button">ì‚­ì œ</button>
                <button class="btn btn-outline-secondary" type="button" id="reset-btn">âœ¨ ì „ì²´ ì´ˆê¸°í™”</button>
            </div>

            <div id="basic-info-form">
                <div class="mb-2"><label for="customer_name">ê³ ê°ëª… & ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-field" id="customer_name"></div>
                <div class="mb-2"><label for="address">ì£¼ì†Œ</label><input type="text" class="form-control form-field" id="address"></div>

                <div class="row g-2 mb-2">
                    <div class="col-md-6"><label for="deduction_region">ë°©ê³µì œ ì§€ì—­</label><select class="form-select form-field" id="deduction_region">
                        <option value="0" selected>ì§€ì—­ ì„ íƒ...</option>
                        {% for region, amount in region_map.items() %}<option value="{{ amount }}">{{ region }}</option>{% endfor %}
                    </select></div>
                    <div class="col-md-6"><label for="deduction_amount">ë°©ê³µì œ ê¸ˆì•¡(ë§Œ)</label><input type="text" class="form-control form-field manwon-format" id="deduction_amount"></div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-6"><label for="kb_price">KB ì‹œì„¸(ë§Œ)</label><input type="text" class="form-control form-field manwon-format" id="kb_price"></div>
                    <div class="col-md-6"><label for="area">ì „ìš©ë©´ì (ã¡)</label><input type="text" class="form-control form-field" id="area"></div>
                </div>
                
                <div class="btn-group w-100 mt-3"><a href="https://kbland.kr/map?xy=37.5205559,126.9265729,17" target="_blank" class="btn btn-warning btn-sm">KBì‹œì„¸</a><a href="https://www.howsmuch.com" target="_blank" class="btn btn-info btn-sm">í•˜ìš°ìŠ¤ë¨¸ì¹˜</a><a href="http://www.iros.go.kr" target="_blank" class="btn btn-secondary btn-sm">ì¸í„°ë„·ë“±ê¸°ì†Œ</a></div>

                 <div class="col-12"><div id="price-type-info" class="fw-bold"></div></div>
            </div>
<hr class="my-4">
            
            <div class="d-flex justify-content-between align-items-center border-bottom">
                <ul class="nav nav-tabs" id="myTab" role="tablist" style="border-bottom: 0;">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="loan-tab" data-bs-toggle="tab" data-bs-target="#loan-tab-pane" type="button" role="tab">ëŒ€ì¶œ í•­ëª©</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="ltv-tab" data-bs-toggle="tab" data-bs-target="#ltv-tab-pane" type="button" role="tab">LTV ë¹„ìœ¨</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="fee-tab" data-bs-toggle="tab" data-bs-target="#fee-tab-pane" type="button" role="tab">ìˆ˜ìˆ˜ë£Œ</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="interest-calc-tab" data-bs-toggle="tab" data-bs-target="#interest-calc-tab-pane" type="button" role="tab">ì´ì ê³„ì‚°ê¸°</button></li>
                </ul>
                <div>
                    <button type="button" class="btn btn-secondary btn-sm" id="add-loan-btn">+ ëŒ€ì¶œ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>

            <div class="tab-content pt-3">
                <div class="tab-pane fade show active" id="loan-tab-pane" role="tabpanel">
                <!-- âœ¨ í—¤ë” ë ˆì´ì•„ì›ƒ ìˆ˜ì •: ìˆœì„œ ì¡°ì • ë²„íŠ¼ìš© ê³µê°„ ì¶”ê°€ -->
                <div class="d-flex border-bottom pb-2 mb-1 fw-bold" style="font-size: 0.85rem; gap: 0.5rem;">
                    <div style="flex: 0 0 8%;">ìˆœì„œ</div>
                    <div style="flex: 0 0 25%;">ì„¤ì •ì</div>
                    <div style="flex: 0 0 15%;">ì±„ê¶Œìµœê³ ì•¡(ë§Œ)</div>
                    <div style="flex: 0 0 10%;">ë¹„ìœ¨(%)</div>
                    <div style="flex: 0 0 15%;">ì›ê¸ˆ(ë§Œ)</div>
                    <div style="flex: 0 0 15%;">êµ¬ë¶„</div>
                    <div style="flex: 0 0 5%;"></div>
                </div>
                    <div id="loan-items-container"></div>
                </div>
                <div class="tab-pane fade" id="ltv-tab-pane" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-6"><label for="ltv1">LTV ë¹„ìœ¨ â‘  (%)</label><input type="text" class="form-control form-field" id="ltv1" value="80"></div>
                        <div class="col-6"><label for="ltv2">LTV ë¹„ìœ¨ â‘¡ (%)</label><input type="text" class="form-control form-field" id="ltv2" value=""></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="fee-tab-pane" role="tabpanel">
                    <div class="row g-2">
                        <div class="col"><label>ì»¨ì„¤íŒ…(ë§Œ)</label><input type="text" class="form-control form-field manwon-format" id="consult_amt" value="0"></div>
                        <div class="col"><label>(%)</label><input type="text" class="form-control form-field" id="consult_rate" value="1.5"></div>
                        <div class="col"><label>ë¸Œë¦¿ì§€(ë§Œ)</label><input type="text" class="form-control form-field manwon-format" id="bridge_amt" value="0"></div>
                        <div class="col"><label>(%)</label><input type="text" class="form-control form-field" id="bridge_rate" value="0.7"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="interest-calc-tab-pane" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="interest-loan-amount" class="form-label">ëŒ€ì¶œê¸ˆì•¡ (ë§Œì›)</label>
                            <input type="text" class="form-control" id="interest-loan-amount" placeholder="">
                        </div>
                        <div class="col-md-6">
                            <label for="interest-annual-rate" class="form-label">ì—°ì´ìœ¨ (%)</label>
                            <input type="text" class="form-control" id="interest-annual-rate" placeholder="">
                        </div>
                    </div>
                        <div class="row g-3 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">í•˜ë£¨ ì´ì (ì›)</label>
                                <input type="text" class="form-control" id="interest-daily-result" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">í•œë‹¬ ì´ì (ì›)</label>
                                <input type="text" class="form-control" id="interest-monthly-result" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">1ë…„ ì´ì (ì›)</label>
                                <input type="text" class="form-control" id="interest-yearly-result" readonly>
                            </div>
                        </div>
                        <hr class="my-4">
                        <h6 class="mb-3 text-success">ì›ê¸ˆ ë¶„í• Â·ë§Œê¸°ì¼ì‹œ ëŒ€ì¶œ ê³„ì‚°ê¸°</h6>
                        <!-- ëŒ€ì¶œê¸ˆ, ì—°ì´ìœ¨ í•„ë“œ ì‚­ì œí•˜ê³  ë°”ë¡œ ì›ê¸ˆ ë¶„í•  ë¹„ìœ¨ë¶€í„° ì‹œì‘ -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label for="balloon-principal-pct" class="form-label">ì›ê¸ˆ ë¶„í•  ë¹„ìœ¨ (X%)</label>
                                <input type="number" class="form-control" id="balloon-principal-pct" value="7" min="0" max="100" step="0.1">
                            </div>
                            <div class="col-md-6">
                                <label for="balloon-months" class="form-label">ê¸°ê°„ (ê°œì›”)</label>
                                <input type="number" class="form-control" id="balloon-months" value="60" min="1" step="1">
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label text-success">ë§¤ì›” ì›ê¸ˆ</label>
                                <input type="text" class="form-control bg-light" id="balloon-monthly-principal" readonly>
                                <small class="text-muted">ì˜ˆ) 3ì–µ, 7%, 60ê°œì›” â†’ 350,000ì›</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-info">ì²« ë‹¬ ë‚©ì…ì•¡</label>
                                <input type="text" class="form-control bg-light" id="balloon-first-payment" readonly>
                                <small class="text-muted" id="balloon-first-breakdown">(ì›ê¸ˆ + ì´ì)</small>
                            </div>
                        </div>
                    </div>
                </div>    
            </div>                
            <hr class="my-4">
            <h5 class="mb-3">ê²°ê³¼</h5>
            <textarea class="form-control" id="generated-memo" rows="15" placeholder="ì…ë ¥/ìˆ˜ì • ì‹œ ì ì‹œ í›„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìš”ì•½ ë©”ëª¨ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."></textarea>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button class="btn btn-primary" id="save-new-btn" type="button">ì‹ ê·œ ê³ ê°ìœ¼ë¡œ ì €ì¥</button>
                <button class="btn btn-success" id="update-btn" type="button">ê¸°ì¡´ ê³ ê° ì •ë³´ ìˆ˜ì •</button>
            </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let loanItemCounter = 0;
    let memoDebounceTimeout;

    // ê³ ê¸‰ ê¸ˆì•¡ íŒŒì‹± í•¨ìˆ˜
    function parseAdvancedAmount(text) {
        if (!text) return 0;
        
        let cleanText = text.replace(/,/g, '').trim();
        
        // 1. í•œê¸€ ê¸ˆì•¡ ì²˜ë¦¬ (ì–µ, ë§Œ, ì²œ, ì› í¬í•¨)
        if (/ì–µ|ë§Œ|ì²œ|ì›/.test(cleanText)) {
            return parseKoreanAmountAdvanced(cleanText);
        }
        
        // 2. ì› ë‹¨ìœ„ ê¸ˆì•¡ ì²˜ë¦¬ (8ìë¦¬ ì´ìƒì´ê±°ë‚˜ 'ì›'ìœ¼ë¡œ ëë‚˜ëŠ” ê²½ìš°)
        if (cleanText.endsWith('ì›') || cleanText.replace(/[^\d]/g, '').length >= 8) {
            const numOnly = cleanText.replace(/[^\d]/g, '');
            if (numOnly) {
                const wonAmount = parseInt(numOnly);
                // ì›ì„ ë§Œì›ìœ¼ë¡œ ë³€í™˜
                return Math.floor(wonAmount / 10000);
            }
        }
        
        // 3. ì¼ë°˜ ìˆ«ì ì²˜ë¦¬
        const numOnly = cleanText.replace(/[^\d]/g, '');
        return numOnly ? parseInt(numOnly) : 0;
    }

    // í•œê¸€ ê¸ˆì•¡ ê³ ê¸‰ íŒŒì‹±
    function parseKoreanAmountAdvanced(text) {
        let total = 0;
        let remainingText = text;
        
        // ì–µ ë‹¨ìœ„ ì²˜ë¦¬
        const eokMatch = remainingText.match(/(\d+)ì–µ/);
        if (eokMatch) {
            total += parseInt(eokMatch[1]) * 10000;
            remainingText = remainingText.replace(eokMatch[0], '');
        }
        
        // ì²œë§Œ ë‹¨ìœ„ ì²˜ë¦¬ (ì˜ˆ: 2ì²œë§Œ = 2000ë§Œ)
        const cheonmanMatch = remainingText.match(/(\d+)ì²œë§Œ/);
        if (cheonmanMatch) {
            total += parseInt(cheonmanMatch[1]) * 1000;
            remainingText = remainingText.replace(cheonmanMatch[0], '');
        }
        
        // ë§Œ ë‹¨ìœ„ ì²˜ë¦¬
        const manMatch = remainingText.match(/(\d+)ë§Œ/);
        if (manMatch) {
            total += parseInt(manMatch[1]);
            remainingText = remainingText.replace(manMatch[0], '');
        }
        
        // ì²œ ë‹¨ìœ„ ì²˜ë¦¬ (ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜)
        const cheonMatch = remainingText.match(/(\d+)ì²œ/);
        if (cheonMatch) {
            total += parseInt(cheonMatch[1]) / 10; // ì²œì›ì„ ë§Œì›ìœ¼ë¡œ ë³€í™˜
            remainingText = remainingText.replace(cheonMatch[0], '');
        }
        
        return Math.floor(total);
    }

    // í•œê¸€ ê¸ˆì•¡ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    function parseKoreanNumberString(text) {
        return parseAdvancedAmount(text);
    }

    // ì› ë‹¨ìœ„ë¥¼ ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function convertWonToManwon(wonAmount) {
        return parseAdvancedAmount(wonAmount);
    }

    // ì±„ê¶Œìµœê³ ì•¡ê³¼ ë¹„ìœ¨ë¡œ ì›ê¸ˆ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    function calculatePrincipalFromRatio(maxAmount, ratio) {
        const maxAmt = parseFloat(String(maxAmount).replace(/,/g, '')) || 0;
        const ratioVal = parseFloat(ratio) || 120;
        
        if (ratioVal <= 0) return 0;
        
        // ì›ê¸ˆ = ì±„ê¶Œìµœê³ ì•¡ Ã· (ë¹„ìœ¨/100)
        return Math.round(maxAmt / (ratioVal / 100));
    }

    // âœ¨ ìˆœì„œ ì¡°ì • ê¸°ëŠ¥ ì¶”ê°€
    function moveLoanItemUp(index) {
        const container = document.getElementById('loan-items-container');
        const items = Array.from(container.children);
        const currentItem = document.getElementById(`loan-item-${index}`);
        const currentIndex = items.indexOf(currentItem);
        
        if (currentIndex > 0) {
            const previousItem = items[currentIndex - 1];
            container.insertBefore(currentItem, previousItem);
            updateOrderButtonStates();
            triggerMemoGeneration();
        }
    }

    function moveLoanItemDown(index) {
        const container = document.getElementById('loan-items-container');
        const items = Array.from(container.children);
        const currentItem = document.getElementById(`loan-item-${index}`);
        const currentIndex = items.indexOf(currentItem);
        
        if (currentIndex < items.length - 1) {
            const nextItem = items[currentIndex + 1];
            container.insertBefore(nextItem, currentItem);
            updateOrderButtonStates();
            triggerMemoGeneration();
        }
    }

    function updateOrderButtonStates() {
        const container = document.getElementById('loan-items-container');
        const items = Array.from(container.children);
        
        items.forEach((item, index) => {
            const upBtn = item.querySelector('.order-btn-up');
            const downBtn = item.querySelector('.order-btn-down');
            
            if (upBtn && downBtn) {
                upBtn.disabled = (index === 0);
                downBtn.disabled = (index === items.length - 1);
            }
        });
    }

    // createLoanItemHTML í•¨ìˆ˜ - ìˆœì„œ ì¡°ì • ë²„íŠ¼ ì¶”ê°€
    function createLoanItemHTML(index, loan = {}) {
        const formatValue = (val) => {
            if (!val) return '0';
            const numValue = Number(String(val).replace(/,/g, ''));
            return numValue ? numValue.toLocaleString() : '0';
        };
        
        return `
        <div id="loan-item-${index}" class="loan-item d-flex align-items-center py-2 border-bottom" style="gap: 0.5rem;">
            <div style="flex: 0 0 8%;" class="text-center">
                <div class="mobile-label">ìˆœì„œ</div>
                <div class="order-buttons">
                    <button type="button" class="order-btn order-btn-up" onclick="moveLoanItemUp(${index})" title="ìœ„ë¡œ ì´ë™">â–²</button>
                    <button type="button" class="order-btn order-btn-down" onclick="moveLoanItemDown(${index})" title="ì•„ë˜ë¡œ ì´ë™">â–¼</button>
                </div>
            </div>
            <div style="flex: 0 0 25%;">
                <div class="mobile-label">ì„¤ì •ì</div>
                <input type="text" class="form-control form-control-sm loan-input form-field" name="lender" value="${loan.lender || ''}">
            </div>
            <div style="flex: 0 0 15%;">
                <div class="mobile-label">ì±„ê¶Œìµœê³ ì•¡(ë§Œ)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field manwon-format" name="max_amount" value="${formatValue(loan.max_amount)}">
            </div>
            <div style="flex: 0 0 10%;">
                <div class="mobile-label">ë¹„ìœ¨(%)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field" name="ratio" value="${loan.ratio || '120'}">
            </div>
            <div style="flex: 0 0 15%;">
                <div class="mobile-label">ì›ê¸ˆ(ë§Œ)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field manwon-format" name="principal" value="${formatValue(loan.principal)}">
            </div>
            <div style="flex: 0 0 15%;">
                <div class="mobile-label">êµ¬ë¶„</div>
                <select class="form-select form-select-sm loan-input form-field" name="status">
                    <option value="ìœ ì§€" ${loan.status === 'ìœ ì§€' ? 'selected' : ''}>ìœ ì§€</option>
                    <option value="ëŒ€í™˜" ${loan.status === 'ëŒ€í™˜' ? 'selected' : ''}>ëŒ€í™˜</option>
                    <option value="ì„ ë§ì†Œ" ${loan.status === 'ì„ ë§ì†Œ' ? 'selected' : ''}>ì„ ë§ì†Œ</option>
                    <option value="í‡´ê±°ìê¸ˆ" ${loan.status === 'í‡´ê±°ìê¸ˆ' ? 'selected' : ''}>í‡´ê±°ìê¸ˆ</option>
                    <option value="ë™ì˜" ${loan.status === 'ë™ì˜' ? 'selected' : ''}>ë™ì˜</option>
                    <option value="ë¹„ë™ì˜" ${loan.status === 'ë¹„ë™ì˜' ? 'selected' : ''}>ë¹„ë™ì˜</option>
                </select>
            </div>
            <div style="flex: 0 0 5%;" class="text-center">
                <button type="button" class="btn-close" aria-label="Close" onclick="removeLoanItem(${index})"></button>
            </div>
        </div>`;
    }

    // âœ¨ [ì‹ ê·œ] ë‹¨ìˆœ ì´ì ê³„ì‚° í•¨ìˆ˜
    function calculateSimpleInterest() {
        // ì…ë ¥ ìš”ì†Œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');

        // ì½¤ë§ˆ(,) ì œê±°í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
        const principalManwon = parseInt(loanAmountInput.value.replace(/,/g, '')) || 0;
        const principal = principalManwon * 10000; // ì› ë‹¨ìœ„ë¡œ ë³€í™˜
        const annualRate = parseFloat(annualRateInput.value) || 0;

        // ê²°ê³¼ í‘œì‹œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const dailyResultEl = document.getElementById('interest-daily-result');
        const monthlyResultEl = document.getElementById('interest-monthly-result');
        const yearlyResultEl = document.getElementById('interest-yearly-result');

        // ì…ë ¥ê°’ì´ ìœ íš¨í•  ë•Œë§Œ ê³„ì‚°
        if (principal > 0 && annualRate > 0) {
            const yearlyInterest = Math.floor(principal * (annualRate / 100));
            const monthlyInterest = Math.floor(yearlyInterest / 12);
            const dailyInterest = Math.floor(yearlyInterest / 365);

            // ê³„ì‚°ëœ ê°’ì„ ì½¤ë§ˆì™€ í•¨ê»˜ 'ì›' ë‹¨ìœ„ë¡œ í‘œì‹œ
            yearlyResultEl.value = yearlyInterest.toLocaleString() + 'ì›';
            monthlyResultEl.value = monthlyInterest.toLocaleString() + 'ì›';
            dailyResultEl.value = dailyInterest.toLocaleString() + 'ì›';
        } else {
            // ì…ë ¥ê°’ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ê²°ê³¼ë¥¼ ''ìœ¼ë¡œ ì´ˆê¸°í™”
            yearlyResultEl.value = '';
            monthlyResultEl.value = '';
            dailyResultEl.value = '';
        }
    }

    // âœ¨ ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜
    function addLoanItem(loan = {}) {
        const container = document.getElementById('loan-items-container');
        container.insertAdjacentHTML('beforeend', createLoanItemHTML(loanItemCounter++, loan));
        attachEventListenersForLoanItems();
    }

    // ëŒ€ì¶œ í•­ëª© ì œê±°
    function removeLoanItem(index) {
        document.getElementById(`loan-item-${index}`)?.remove();
        triggerMemoGeneration();
    }
    
    // ìˆ«ì ìë™ í¬ë§· (ê°œì„ ëœ ê³ ê¸‰ ê¸ˆì•¡ ì²˜ë¦¬)
    function formatManwonValue(e) {
        const field = e.target;
        let value = field.value.trim();
        let parsedValue = 0;

        // ë¹ˆ ê°’ ì²˜ë¦¬
        if (!value) {
            field.value = '';
            triggerMemoGeneration();
            return;
        }

        // '+' ê¸°í˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ê³„ì‚°
        if (value.includes('+')) {
            const terms = value.split('+');
            parsedValue = terms.reduce((acc, term) => {
                return acc + parseAdvancedAmount(term.trim());
            }, 0);
        } else {
            parsedValue = parseAdvancedAmount(value);
        }
        
        // ê³„ì‚°ëœ ê°’ì„ ì…ë ¥ì°½ì— ë‹¤ì‹œ ì„¤ì •
        field.value = parsedValue > 0 ? parsedValue.toLocaleString() : '';

        // ë©”ëª¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
        triggerMemoGeneration();
    }

    // [ìˆ˜ì •ë¨] ëŒ€ì¶œ í•­ëª© ìë™ ê³„ì‚° (ì›ê¸ˆ-ìµœê³ ì•¡) - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ
    function handleAutoLoanCalc(event) {
        const target = event.target;
        const loanItem = target.closest('.loan-item');
        if (!loanItem) return;

        const maxAmountInput = loanItem.querySelector('[name="max_amount"]');
        const ratioInput = loanItem.querySelector('[name="ratio"]');
        const principalInput = loanItem.querySelector('[name="principal"]');

        let maxAmount = parseFloat(maxAmountInput.value.replace(/,/g, '')) || 0;
        let ratio = parseFloat(ratioInput.value) || 0;
        let principal = parseFloat(principalInput.value.replace(/,/g, '')) || 0;

        if (target.name === 'principal') {
            // ì›ê¸ˆì´ ë°”ë€Œë©´ ë¹„ìœ¨ì— ë”°ë¼ ìµœê³ ì•¡ ì—­ì‚°
            if (principal > 0 && ratio > 0) {
                maxAmount = Math.round(principal * (ratio / 100));
                maxAmountInput.value = maxAmount.toLocaleString();
            }
        } else {
            // ìµœê³ ì•¡ ë˜ëŠ” ë¹„ìœ¨ì´ ë°”ë€Œë©´ ì›ê¸ˆ ê³„ì‚°
            if (maxAmount > 0 && ratio > 0) {
                principal = Math.round(maxAmount / (ratio / 100));
                principalInput.value = principal.toLocaleString();
            }
        }
        triggerMemoGeneration();
    }
    
    // [ì‹ ê·œ] ì±„ê¶Œìµœê³ ì•¡ ì…ë ¥ ì‹œ ì„œë²„ APIë¥¼ í†µí•´ ê¸ˆì•¡ ë³€í™˜ ë° ì›ê¸ˆ ìë™ê³„ì‚°
    async function handleApiLoanConversion(event) {
        const maxAmountInput = event.target;
        const loanItem = maxAmountInput.closest('.loan-item');
        if (!loanItem) return;

        const ratioInput = loanItem.querySelector('[name="ratio"]');
        const principalInput = loanItem.querySelector('[name="principal"]');

        const loanData = {
            max_amount: maxAmountInput.value,
            ratio: ratioInput.value
        };

        try {
            const response = await fetch('/api/convert_loan_amount', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loanData)
            });

            if (!response.ok) throw new Error('API call failed');
            const result = await response.json();

            if (result.success && result.converted_data) {
                const data = result.converted_data;
                maxAmountInput.value = data.max_amount ? parseInt(data.max_amount).toLocaleString() : '0';
                principalInput.value = data.principal ? parseInt(data.principal).toLocaleString() : '0';
            }
        } catch (error) {
            console.error('Error during loan conversion:', error);
            // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ, í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
            handleAutoLoanCalc(event); 
        } finally {
            triggerMemoGeneration();
        }
    }
    
    // âœ¨ [ì‹ ê·œ] ë°©ê³µì œ ë° ì„ì°¨ì¸(ë™ì˜/ë¹„ë™ì˜) ìƒíƒœì— ë”°ë¥¸ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function checkTenantDeductionWarning() {
        const deductionRegionSelect = document.getElementById('deduction_region');
        // "ì§€ì—­ ì„ íƒ..." ë˜ëŠ” "ë°©ê³µì œ ì—†ìŒ" ë“±ì˜ ê¸°ë³¸ê°’(value="0")ì´ ì•„ë‹Œ ê²½ìš°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        const isDeductionSelected = deductionRegionSelect.value && deductionRegionSelect.value !== '0';

        if (!isDeductionSelected) {
            return; // ë°©ê³µì œ ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²€ì‚¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
        }

        const tenantStatuses = ['ë™ì˜', 'ë¹„ë™ì˜'];
        let hasTenantLoan = false;
        // í˜„ì¬ í™”ë©´ì— ìˆëŠ” ëª¨ë“  ëŒ€ì¶œ í•­ëª©ì˜ 'ì§„í–‰' ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        document.querySelectorAll('.loan-item [name="status"]').forEach(statusSelect => {
            if (tenantStatuses.includes(statusSelect.value)) {
                hasTenantLoan = true;
            }
        });

        // ë°©ê³µì œ ì§€ì—­ì´ ì„ íƒë˜ì—ˆê³ , 'ë™ì˜' ë˜ëŠ” 'ë¹„ë™ì˜' ìƒíƒœì˜ ëŒ€ì¶œì´ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ ê²½ê³  ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        if (hasTenantLoan) {
            alert("ì„ì°¨ì¸ì´ ê±°ì£¼í•˜ê³  ìˆëŠ” ë¬¼ê±´ì§€ëŠ” ë°©ê³µì œê¸ˆì•¡ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì„¸í‡´ê±°ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”");
        }
    }

    // [ìˆ˜ì •ë¨] ë™ì  ìƒì„±ëœ ëŒ€ì¶œ í•­ëª©ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    function attachEventListenersForLoanItems() {
        document.querySelectorAll('.loan-item').forEach(item => {
            const maxAmountInput = item.querySelector('[name="max_amount"]');
            const ratioInput = item.querySelector('[name="ratio"]');
            const principalInput = item.querySelector('[name="principal"]');
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ëª¨ë‘ ì œê±°í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
            const newMaxAmountInput = maxAmountInput.cloneNode(true);
            const newRatioInput = ratioInput.cloneNode(true);
            const newPrincipalInput = principalInput.cloneNode(true);

            maxAmountInput.parentNode.replaceChild(newMaxAmountInput, maxAmountInput);
            ratioInput.parentNode.replaceChild(newRatioInput, ratioInput);
            principalInput.parentNode.replaceChild(newPrincipalInput, principalInput);

            // [í•µì‹¬] ì±„ê¶Œìµœê³ ì•¡: í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ì„œë²„ APIë¡œ ë³€í™˜ ìš”ì²­
            newMaxAmountInput.addEventListener('blur', handleApiLoanConversion);
            
            // ë¹„ìœ¨: ê°’ì´ ë³€ê²½ë  ë•Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì›ê¸ˆ ì¦‰ì‹œ ì¬ê³„ì‚°
            newRatioInput.addEventListener('change', handleAutoLoanCalc);
            
            // ì›ê¸ˆ: í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ìˆ«ì í¬ë§·íŒ… / ê°’ì´ ë³€ê²½ë  ë•Œ ìµœê³ ì•¡ ì—­ì‚°
            newPrincipalInput.addEventListener('blur', formatManwonValue);
            newPrincipalInput.addEventListener('change', handleAutoLoanCalc);

            // ëª¨ë“  í•­ëª©ì˜ ê°’ì´ ë³€ê²½ë˜ë©´ ë©”ëª¨ ì—…ë°ì´íŠ¸
            item.querySelectorAll('.loan-input').forEach(input => {
                // âœ¨ [ìˆ˜ì •] 'change' ì´ë²¤íŠ¸ì— ê²½ê³  í™•ì¸ ë¡œì§ ì¶”ê°€
                input.addEventListener('change', (e) => {
                    // ë§Œì•½ ë³€ê²½ëœ í•„ë“œê°€ 'status'ë¼ë©´, ì„ì°¨ì¸/ë°©ê³µì œ ê²½ê³ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                    if (e.target.name === 'status') {
                        checkTenantDeductionWarning();
                    }
                    // ê¸°ì¡´ì˜ ë©”ëª¨ ìƒì„± í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                    triggerMemoGeneration();
                });
            });
        });
    }

    // ëª¨ë“  í¼ ë°ì´í„° ìˆ˜ì§‘
    function collectAllData() {
        const regionSelect = document.getElementById('deduction_region');
        const selectedRegionText = regionSelect.options[regionSelect.selectedIndex].text;
        const loanItems = Array.from(document.querySelectorAll('.loan-item')).map(item => ({
            lender: item.querySelector('[name="lender"]').value, 
            status: item.querySelector('[name="status"]').value,
            max_amount: item.querySelector('[name="max_amount"]').value, 
            principal: item.querySelector('[name="principal"]').value,
            ratio: item.querySelector('[name="ratio"]').value,
        }));
        return {
            inputs: {
                customer_name: document.getElementById('customer_name').value, 
                address: document.getElementById('address').value,
                kb_price: document.getElementById('kb_price').value, 
                area: document.getElementById('area').value,
                deduction_region_text: selectedRegionText, 
                deduction_amount: document.getElementById('deduction_amount').value,
                ltv_rates: [document.getElementById('ltv1').value, document.getElementById('ltv2').value],
            }, 
            fees: {
                consult_amt: document.getElementById('consult_amt').value, 
                consult_rate: document.getElementById('consult_rate').value,
                bridge_amt: document.getElementById('bridge_amt').value, 
                bridge_rate: document.getElementById('bridge_rate').value,
            }, 
            loans: loanItems
        };
    }
    
    // ë©”ëª¨ ìƒì„± ìš”ì²­ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    function triggerMemoGeneration() {
        clearTimeout(memoDebounceTimeout);
        memoDebounceTimeout = setTimeout(generateMemo, 800); 
    }

    // ë©”ëª¨ ìƒì„± ë° í•˜ì•ˆê°€/ì¼ë°˜ê°€ í‘œì‹œ
    async function generateMemo() {
        const memoArea = document.getElementById('generated-memo');
        memoArea.placeholder = 'ìš”ì•½ ë©”ëª¨ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
        const data = collectAllData();
        const requestData = { inputs: data.inputs, loans: data.loans, fees: data.fees };
        try {
            const response = await fetch('/api/generate_text_memo', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData)
            });
            const result = await response.json();
            memoArea.value = result.memo || 'ì˜¤ë¥˜: ë©”ëª¨ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            
            const priceTypeInfo = document.getElementById('price-type-info');
            if (result.price_type) {
                priceTypeInfo.textContent = `ì‹œì„¸ ì ìš©: ${result.price_type}`;
                
                // âœ¨ 1. ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ë¨¼ì € ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
                priceTypeInfo.classList.remove('text-danger', 'text-primary');

                // âœ¨ 2. ì‹œì„¸ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                if (result.price_type.includes('ì¼ë°˜ê°€')) {
                    priceTypeInfo.classList.add('text-primary'); // 'ì¼ë°˜ê°€'ëŠ” íŒŒë€ìƒ‰
                } else if (result.price_type.includes('í•˜ì•ˆê°€')) {
                    priceTypeInfo.classList.add('text-danger');  // 'í•˜ì•ˆê°€'ëŠ” ë¹¨ê°„ìƒ‰
                }
            } else {
                // ë‚´ìš©ì´ ì—†ì„ ê²½ìš°, í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
                priceTypeInfo.textContent = '';
                priceTypeInfo.classList.remove('text-danger', 'text-primary');
            }
        } catch (error) {
            memoArea.value = `ì˜¤ë¥˜: ë©”ëª¨ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error})`;
        }
    }
    
    // ê³ ê° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCustomerList() {
        try {
            const response = await fetch('/api/customers');
            const customers = await response.json();
            const select = document.getElementById('customer-history');
            select.innerHTML = '<option value="" selected>ê¸°ì¡´ ê³ ê° ë¶ˆëŸ¬ì˜¤ê¸°...</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        } catch (error) { 
            console.error("ê³ ê° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error); 
        }
    }

    // íŠ¹ì • ê³ ê° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCustomerData() {
        const select = document.getElementById('customer-history');
        const pageId = select.value;
        if (!pageId) return;
        try {
            const response = await fetch(`/api/customer/${pageId}`);
            if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
            const data = await response.json();
            if (data.error) { alert(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${data.error}`); return; }
            
            document.getElementById('customer_name').value = data.customer_name || '';
            document.getElementById('address').value = data.address || '';
            document.getElementById('kb_price').value = (data.kb_price || '').toLocaleString();
            document.getElementById('area').value = data.area || '';
            document.getElementById('ltv1').value = data.ltv1 || '80';
            document.getElementById('ltv2').value = data.ltv2 || '';
            document.getElementById('consult_amt').value = (data.consult_amt || '0').toLocaleString();
            document.getElementById('consult_rate').value = data.consult_rate || '1.5';
            document.getElementById('bridge_amt').value = (data.bridge_amt || '0').toLocaleString();
            document.getElementById('bridge_rate').value = data.bridge_rate || '0.7';
            
            const regionSelect = document.getElementById('deduction_region');
            const regionOption = Array.from(regionSelect.options).find(opt => opt.text === data.deduction_region);
            if(regionOption) {
                regionSelect.value = regionOption.value;
            } else if(regionSelect.options.length > 0) {
                regionSelect.selectedIndex = 0;
            }
            document.getElementById('deduction_amount').value = (regionSelect.value || '').toLocaleString();
            document.getElementById('loan-items-container').innerHTML = '';
            loanItemCounter = 0;

            if (data.loans && data.loans.length > 0) {
                data.loans.forEach(loan => addLoanItem(loan));
            } else { 
                addLoanItem(); 
            }

            triggerMemoGeneration();
        } catch (error) {
            alert(`ê³ ê° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }
    
    // âœ¨ ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜ë“¤
    async function saveNewCustomer() {
        const data = collectAllData();
        if (!data.inputs.customer_name) { 
            alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
            return; 
        }
        if (!confirm(`'${data.inputs.customer_name}' ì´ë¦„ìœ¼ë¡œ ì‹ ê·œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const response = await fetch('/api/customer/new', { 
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) { 
            loadCustomerList(); 
        }
    }

    async function updateCustomer() {
        const selectedCustomerId = document.getElementById('customer-history').value;
        if (!selectedCustomerId) { 
            alert('ìˆ˜ì •í•  ê³ ê°ì„ ëª©ë¡ì—ì„œ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); 
            return; 
        }
        const data = collectAllData();
        if (!confirm(`'${data.inputs.customer_name}' ê³ ê° ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const url = `/api/customer/update/${selectedCustomerId}`;
        const response = await fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) { 
            loadCustomerList(); 
        }
    }

    async function deleteCustomer() {
        const select = document.getElementById('customer-history');
        const selectedCustomerId = select.value;

        if (!selectedCustomerId) {
            alert('ì‚­ì œí•  ê³ ê°ì„ ëª©ë¡ì—ì„œ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // --- âœ¨ ìš”ì²­ì‚¬í•­ì— ë§ì¶° ì•”í˜¸ í™•ì¸ ë¡œì§ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤ ---

        // 1. "ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" ë¼ëŠ” ë©”ì‹œì§€ë¡œ í”„ë¡¬í”„íŠ¸ ì°½ì„ ë„ì›ë‹ˆë‹¤.
        const enteredPassword = prompt("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        // 2. ì‚¬ìš©ìê°€ 'ì·¨ì†Œ' ë²„íŠ¼ì„ ëˆŒë €ì„ ê²½ìš°
        if (enteredPassword === null) {
            alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤");
            return;
        }

        // 3. ì•”í˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        const deletePassword = "1245"; // ìš”ì²­í•˜ì‹  ì•”í˜¸ "1245"
        if (enteredPassword === deletePassword) {
            // ì•”í˜¸ê°€ ì¼ì¹˜í•˜ë©´ ì„œë²„ì— ì‚­ì œ ìš”ì²­
            try {
                const url = `/api/customer/delete/${selectedCustomerId}`;
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();
                alert(result.message); // ì„œë²„ì˜ ì‘ë‹µ ë©”ì‹œì§€ (ì˜ˆ: 'ê³ ê° ì •ë³´ê°€ ì‚­ì œ(ë³´ê´€)ë˜ì—ˆìŠµë‹ˆë‹¤.')
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                alert('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('Delete error:', error);
            }
        } else {
            // 4. ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš°
            alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì‚­ì œ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
        }
    }

    // PDF íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    async function handleFileUpload(file) {
        console.log("--- handleFileUpload í•¨ìˆ˜ ì‹¤í–‰ ---");
        const spinner = document.getElementById('upload-spinner');
        spinner.style.display = 'block';
        const formData = new FormData();
        formData.append('pdf_file', file);
        try {
            console.log("ì„œë²„ë¡œ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ ì „ì†¡...");
            const response = await fetch('/api/upload', { method: 'POST', body: formData });
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.error || `ì„œë²„ ì—ëŸ¬: ${response.status}`);
            }
            const result = await response.json();
            console.log("ì—…ë¡œë“œ ì„±ê³µ. ì„œë²„ ê²°ê³¼:", result);
            if (result.success) {
                const scraped = result.scraped_data;
                document.getElementById('customer_name').value = scraped.customer_name || '';
                document.getElementById('address').value = scraped.address || '';
                document.getElementById('area').value = scraped.area || '';
                const pdfUrl = `/view_pdf/${encodeURIComponent(result.filename)}`;
                document.getElementById('pdf-viewer').src = pdfUrl;
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('viewer-section').style.display = 'block';
                document.getElementById('file-name-display').textContent = file.name;
                triggerMemoGeneration();
            } else { 
                alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`); 
            }
        } catch (error) {
            console.error("!!!!! íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
            alert(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        } finally {
            spinner.style.display = 'none';
        }
    }

    // ë ˆì´ì•„ì›ƒ í† ê¸€
    function toggleLayout() {
        document.getElementById('main-layout-wrapper').classList.toggle('horizontal-mode');
        const btn = document.getElementById('layout-toggle-btn');
        const isHorizontal = document.getElementById('main-layout-wrapper').classList.contains('horizontal-mode');
        btn.innerHTML = isHorizontal ? '<i class="bi bi-distribute-vertical"></i> ì„¸ë¡œ ëª¨ë“œ' : '<i class="bi bi-distribute-horizontal"></i> ê°€ë¡œ ëª¨ë“œ';
    }
    
    // ì „ì²´ ì´ˆê¸°í™”
    function clearAllFields() {
        document.querySelectorAll('.form-field').forEach(field => {
            if(field.tagName === 'SELECT') { 
                field.selectedIndex = 0; 
            } else { 
                field.value = ''; 
            }
        });
        document.getElementById('ltv1').value = '80';
        document.getElementById('consult_rate').value = '1.5';
        document.getElementById('bridge_rate').value = '0.7';
        document.getElementById('deduction_amount').value = document.getElementById('deduction_region').value.toLocaleString();
        document.getElementById('loan-items-container').innerHTML = '';
        loanItemCounter = 0;
        addLoanItem();
        const fileInput = document.getElementById('file-input');
        if (fileInput) fileInput.value = null;
        document.getElementById('pdf-viewer').src = 'about:blank';
        document.getElementById('upload-section').style.display = 'flex';
        document.getElementById('viewer-section').style.display = 'none';
        alert("ëª¨ë“  ì…ë ¥ ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        triggerMemoGeneration();
    }
    
    // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìµœì´ˆ ì—°ê²°
    function attachAllEventListeners() {
        const uploadSection = document.getElementById('upload-section');
        const fileInput = document.getElementById('file-input');
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => { 
            if (fileInput.files.length > 0) handleFileUpload(fileInput.files[0]); 
        });
        
        ['dragover','dragleave','drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, e => { 
                e.preventDefault(); 
                e.stopPropagation(); 
            }, false);
        });
        
        uploadSection.addEventListener('dragover', () => uploadSection.classList.add('dragover'));
        uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('dragover'));
        uploadSection.addEventListener('drop', (e) => {
            uploadSection.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
        });

        document.querySelectorAll('.manwon-format').forEach(input => {
            input.addEventListener('blur', formatManwonValue);
        });
        
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');

        // í‚¤ë³´ë“œë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì´ì ë‹¤ì‹œ ê³„ì‚°
        loanAmountInput.addEventListener('keyup', calculateSimpleInterest);
        annualRateInput.addEventListener('keyup', calculateSimpleInterest);

        // ëŒ€ì¶œê¸ˆì•¡ ì…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ìˆ«ì í¬ë§·íŒ… (ì½¤ë§ˆ ì¶”ê°€)
        loanAmountInput.addEventListener('blur', (e) => {
            const value = e.target.value.replace(/,/g, '');
            const num = parseInt(value, 10);
            if (!isNaN(num) && num > 0) {
                e.target.value = num.toLocaleString();
            } else {
                e.target.value = '';
            }
        });

            // âœ¨ ì›ê¸ˆ ë¶„í•  ê³„ì‚°ê¸° í•¨ìˆ˜ë“¤ ì¶”ê°€
    function formatNumberWithCommas(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function parseFormattedNumber(value) {
        return Number(value.replace(/,/g, '')) || 0;
    }

    function calculateBalloonLoan() {
        // ê¸°ì¡´ ì´ìê³„ì‚°ê¸° í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');
        const principalPctInput = document.getElementById('balloon-principal-pct');
        const monthsInput = document.getElementById('balloon-months');

        // ê¸°ì¡´ í•„ë“œê°’ ì‚¬ìš© (ë§Œì› ë‹¨ìœ„ë¥¼ ì› ë‹¨ìœ„ë¡œ ë³€í™˜)
        const loanManwon = parseFloat(loanAmountInput.value.replace(/,/g, '')) || 0;
        const loan = loanManwon * 10000; // ë§Œì›ì„ ì›ìœ¼ë¡œ ë³€í™˜
        const annualRate = Number(annualRateInput.value) || 0;
        const principalPct = Math.max(0, Math.min(100, Number(principalPctInput.value) || 0));
        const months = Number(monthsInput.value) || 0;

        const monthlyRate = annualRate > 0 ? annualRate / 100 / 12 : 0;
        const principalPortion = loan * (principalPct / 100);
        const monthlyPrincipal = months > 0 ? principalPortion / months : 0;
        const firstMonthInterest = loan * monthlyRate;
        const firstMonthPayment = monthlyPrincipal + firstMonthInterest;

        document.getElementById('balloon-monthly-principal').value = Math.round(monthlyPrincipal).toLocaleString() + ' ì›';
        document.getElementById('balloon-first-payment').value = Math.round(firstMonthPayment).toLocaleString() + ' ì›';
        document.getElementById('balloon-first-breakdown').textContent = 
            `(ì›ê¸ˆ ${Math.round(monthlyPrincipal).toLocaleString()} + ì´ì ${Math.round(firstMonthInterest).toLocaleString()})`;
    }

    function handleBalloonLoanInput(event) {
        const input = event.target;
        const value = input.value.replace(/,/g, '');
        const num = parseInt(value, 10);
        
        if (!isNaN(num) && num > 0) {
            input.value = num.toLocaleString();
        } else {
            input.value = '';
        }
        
        calculateBalloonLoan();
    }
        

    // ê¸°ì¡´ ì´ìê³„ì‚°ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì›ê¸ˆ ë¶„í•  ê³„ì‚° ì¶”ê°€
    loanAmountInput.addEventListener('keyup', () => {
        calculateSimpleInterest();
        calculateBalloonLoan(); // ì¶”ê°€
    });
    annualRateInput.addEventListener('keyup', () => {
        calculateSimpleInterest();
        calculateBalloonLoan(); // ì¶”ê°€
    });

    // ì›ê¸ˆ ë¶„í•  ê³„ì‚°ê¸° ì „ìš© í•„ë“œë“¤
    const balloonPrincipalPctInput = document.getElementById('balloon-principal-pct');
    const balloonMonthsInput = document.getElementById('balloon-months');

    if (balloonPrincipalPctInput) {
        balloonPrincipalPctInput.addEventListener('input', calculateBalloonLoan);
        balloonMonthsInput.addEventListener('input', calculateBalloonLoan);
        
        // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
        calculateBalloonLoan();
    }


        document.getElementById('load-customer-btn').addEventListener('click', loadCustomerData);
        document.getElementById('delete-customer-btn').addEventListener('click', deleteCustomer);
        document.getElementById('reset-btn').addEventListener('click', clearAllFields);
        document.getElementById('add-loan-btn').addEventListener('click', () => addLoanItem());
        document.getElementById('save-new-btn').addEventListener('click', saveNewCustomer);
        document.getElementById('update-btn').addEventListener('click', updateCustomer);
        document.getElementById('layout-toggle-btn').addEventListener('click', toggleLayout);
        
        // âœ¨ [ìˆ˜ì •] ë°©ê³µì œ ì§€ì—­ ë³€ê²½ ì‹œ ê²½ê³  í™•ì¸ ë¡œì§ì„ í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.
        document.getElementById('deduction_region').addEventListener('change', (e) => {
            document.getElementById('deduction_amount').value = e.target.value.toLocaleString();
            checkTenantDeductionWarning(); // ê²½ê³  í™•ì¸ í•¨ìˆ˜ í˜¸ì¶œ
            triggerMemoGeneration();
        });

        document.querySelectorAll('.form-field:not(.loan-input)').forEach(field => {
            field.addEventListener('change', triggerMemoGeneration);
            if (field.type === 'text' && !field.classList.contains('manwon-format')) {
                field.addEventListener('keyup', triggerMemoGeneration);
            }
        });
        
        document.querySelectorAll('.manwon-format').forEach(input => {
            input.addEventListener('blur', formatManwonValue);
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        addLoanItem();
        attachAllEventListeners();
        loadCustomerList();
        triggerMemoGeneration();
    });
</script>
</body>
</html>
