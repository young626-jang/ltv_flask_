<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <title>LTV ê³„ì‚°ê¸° ë§Œë“ ì´ ì¥ì„œì˜</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/69/69524.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Durekt ìŠ¤íƒ€ì¼ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
            --primary-dark: #2D3748;
            --primary-accent: #D946EF;
            --primary-cyan: #06FFA5;
            --primary-blue: #3B82F6;
            --background-light: #EDF2F7;
            --background-white: #FFFFFF;
            --text-dark: #1A202C;
            --text-muted: #718096;
            --border-light: #E2E8F0;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        html, body { 
            height: 100%; 
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'Inter', 'Malgun Gothic', sans-serif; 
            background: var(--background-light) !important;
            background-color: #F7FAFC !important;
        }
        
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ - ë¦¬ì‚¬ì´ì¦ˆ ë°” ì¶”ê°€ */
        .main-container { 
            display: flex; 
            height: 100vh; 
            padding: 0.5rem; 
            position: relative;
            background: var(--background-light);
            gap: 0.5rem;
        }
        .pdf-viewer-column { 
            flex: none; 
            width: 62.5%; /* ê¸°ë³¸ 2.5/4 ë¹„ìœ¨ */
            display: flex; 
            flex-direction: column; 
            transition: width 0.1s ease;
            background: #F2EDD7;
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: var(--shadow-soft);
        }
        .form-column { 
            flex: none; 
            width: 37.5%; /* ê¸°ë³¸ 1.5/4 ë¹„ìœ¨ */
            height: calc(100vh - 2rem); 
            overflow-y: auto; 
            transition: width 0.1s ease;
            background: var(--background-white);
            border-radius: 12px;
            padding: 0.5rem;
            box-shadow: var(--shadow-soft);
        }
        
        /* ë¦¬ì‚¬ì´ì¦ˆ ë°” ìŠ¤íƒ€ì¼ */
        .resize-bar {
            width: 8px; /* ì„¸ë¡œëª¨ë“œì—ì„œë„ í„°ì¹˜ ì˜ì—­ ì•½ê°„ í™•ëŒ€ */
            background: linear-gradient(to bottom, #e9ecef, #dee2e6, #e9ecef);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            user-select: none;
            z-index: 10;
            transition: all 0.2s ease;
            touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        
        .resize-bar:hover {
            background: linear-gradient(to bottom, #6c757d, #495057, #6c757d);
            box-shadow: 0 0 8px rgba(0,0,0,0.1);
        }
        
        .resize-bar:active {
            background: linear-gradient(to bottom, #495057, #343a40, #495057);
        }
        
        .resize-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: rgba(255,255,255,0.7);
            border-radius: 1px;
        }
        
        .resize-bar::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 4px;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }
        .pdf-iframe-container { flex-grow: 1; position: relative; }
        #pdf-viewer { 
            width: 100%; 
            height: 100%; 
            border: 1px solid var(--border-light); 
            border-radius: 8px; 
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        #upload-section { 
            border: 2px dashed var(--border-light); 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            height: 100%; 
            cursor: pointer; 
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            color: var(--text-muted);
        }
        #upload-section.dragover { 
            border-color: var(--primary-accent); 
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            color: var(--primary-accent);
        }
        #file-input { display: none; }
        body { 
            font-size: 0.9rem; 
            color: var(--text-dark);
            background-color: #EDF2F7;
        }
        label { 
            font-weight: 600; 
            margin-bottom: 0.25rem; 
            color: var(--text-dark);
            font-size: 0.875rem;
        }

        /* Durekt ìŠ¤íƒ€ì¼ ë²„íŠ¼ ì˜¤ë²„ë¼ì´ë“œ */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-accent) 0%, #c026d3 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(212, 70, 239, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #c026d3 0%, #a21caf 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(212, 70, 239, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--primary-cyan) 0%, #00d4aa 100%);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #00d4aa 0%, #059669 100%);
            color: white;
            transform: translateY(-1px);
        }
        
        .btn-outline-primary {
            border: 2px solid var(--primary-accent);
            color: var(--primary-accent);
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-outline-primary:hover {
            background: var(--primary-accent);
            border-color: var(--primary-accent);
        }
        
        .btn-outline-secondary {
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-outline-secondary:hover {
            background: var(--text-muted);
            border-color: var(--text-muted);
        }
        
        /* í¼ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ë§ */
        .form-control, .form-select {
            border: 2px solid var(--border-light);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
            color: var(--text-dark);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(212, 70, 239, 0.1);
            outline: none;
        }
        
        .form-control::placeholder {
            color: var(--text-muted);
        }

        /* âœ¨ ë“œë˜ê·¸ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
        .drag-handle {
            width: 24px;
            height: 40px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            color: #6c757d;
            font-size: 14px;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .drag-handle:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            color: #495057;
        }
        
        .loan-item.dragging {
            opacity: 0.8;
            background-color: rgba(212, 70, 239, 0.2);
            border: 2px solid var(--primary-accent);
            box-shadow: 0 4px 8px rgba(212, 70, 239, 0.3);
        }
        
        .loan-item.drag-over {
            border-top: 4px solid var(--primary-accent);
            background-color: rgba(212, 70, 239, 0.15);
        }

        /* ê°€ë¡œ ëª¨ë“œ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ - ë°˜ì‘í˜• flex ê¸°ë°˜ */
        .main-container.horizontal-mode { 
            flex-direction: column; 
            gap: 0;
            height: 100vh;
            overflow: hidden;
        }
        .main-container.horizontal-mode .pdf-viewer-column { 
            width: 100% !important; 
            flex: 3; /* PDF ì˜ì—­ì´ 3/5 ë¹„ìœ¨ë¡œ ìë™ ì¡°ì • */
            min-height: 150px; /* ìµœì†Œ ë†’ì´ ì¶•ì†Œ */
            max-height: none;
            overflow: hidden;
        }
        .main-container.horizontal-mode .form-column { 
            width: 100% !important; 
            flex: 2; /* í¼ ì˜ì—­ì´ 2/5 ë¹„ìœ¨ë¡œ ìë™ ì¡°ì • */
            min-height: 150px;
            max-height: none;
            overflow-y: auto;
        }
        .main-container.horizontal-mode .resize-bar {
            width: 100% !important;
            height: 8px; /* PCì—ì„œ ì—¬ë°± ì ˆì•½ */
            cursor: row-resize;
            position: relative;
            z-index: 999; /* z-index ì¦ê°€ */
            touch-action: none; /* í„°ì¹˜ ë™ì‘ ì œí•œ */
        }
        
        /* ëª¨ë°”ì¼ì—ì„œë§Œ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
        @media (max-width: 768px) {
            .main-container.horizontal-mode .resize-bar {
                height: 12px !important;
            }
            
            /* ê°€ë¡œëª¨ë“œ ëª¨ë°”ì¼ì—ì„œ ì—…ë¡œë“œ ì˜ì—­ ì»´íŒ©íŠ¸í™” */
            .main-container.horizontal-mode #upload-section {
                min-height: 120px;
            }
            
            .main-container.horizontal-mode #upload-section h4 {
                font-size: 1rem;
                margin-top: 0.5rem;
            }
            
            .main-container.horizontal-mode #upload-section .bi-cloud-arrow-up-fill {
                font-size: 3rem !important;
            }
        }
        .main-container.horizontal-mode .resize-bar::before {
            width: 30px;
            height: 2px;
        }
        .main-container.horizontal-mode .resize-bar::after {
            width: 4px;
            height: 20px;
        }

        /* ============= ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• ê°œì„  ============= */
        
        /* íƒœë¸”ë¦¿ (768px ì´í•˜) */
        @media (max-width: 768px) {
            body {
                font-size: 0.85rem;
            }
            
            .main-container {
                flex-direction: column;
                padding: 0.25rem;
                gap: 0.25rem;
                height: 100vh;
            }
            
            .pdf-viewer-column {
                flex: 0 0 40vh;
                min-height: 180px;
            }
            
            .form-column {
                flex: 1;
                height: auto;
                max-height: none;
                overflow-y: auto;
            }
            
            /* ë²„íŠ¼ë“¤ì„ í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ í¬ê²Œ */
            .btn {
                min-height: 44px; /* ì• í”Œ ê°€ì´ë“œë¼ì¸ 44px */
                font-size: 0.9rem;
            }
            
            .btn-sm {
                min-height: 38px;
                font-size: 0.8rem;
            }
            
            /* ì…ë ¥ í•„ë“œë“¤ì„ í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ */
            .form-control, .form-select {
                min-height: 44px;
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            }
            
            .form-control-sm, .form-select-sm {
                min-height: 38px;
                font-size: 14px;
            }
            
            /* ìˆœì„œ ì¡°ì • ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
            .order-btn {
                width: 28px;
                height: 24px;
                font-size: 12px;
            }
            
            /* ëŒ€ì¶œ í•­ëª© ëª¨ë°”ì¼ ìµœì í™” */
            .loan-item {
                flex-direction: column !important;
                gap: 0.5rem !important;
                padding: 1rem;
                border: 1px solid #dee2e6;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                background: #f8f9fa;
            }
            
            .loan-item > div {
                flex: none !important;
                width: 100% !important;
            }
            
            /* ì—…ë¡œë“œ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            #upload-section {
                min-height: 150px;
            }
            
            #upload-section h4 {
                font-size: 1.1rem;
            }
            
            /* í…ìŠ¤íŠ¸ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            #generated-memo {
                min-height: 300px;
                font-size: 0.85rem;
            }
            
            /* íƒ­ ë²„íŠ¼ë“¤ ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .nav-tabs .nav-link {
                white-space: nowrap;
                min-width: 80px;
            }
        }
        
        /* ëª¨ë°”ì¼ (576px ì´í•˜) */
        @media (max-width: 576px) {
            body {
                font-size: 0.8rem;
            }
            
            .main-container {
                padding: 0.125rem;
            }
            
            .pdf-viewer-column {
                flex: 0 0 35vh;
                min-height: 150px;
            }
            
            /* ë” ì‘ì€ í™”ë©´ì—ì„œëŠ” ë²„íŠ¼ë“¤ì„ ì„¸ë¡œë¡œ */
            .d-grid.gap-2.d-md-flex {
                display: flex !important;
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .d-grid.gap-2.d-md-flex .btn {
                width: 100%;
            }
            
            /* ê³ ê° ì„ íƒ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            .input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .input-group .form-select,
            .input-group .btn {
                width: 100%;
                border-radius: 0.375rem !important;
            }
            
            /* ë§í¬ ë²„íŠ¼ë“¤ ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ë°°ì¹˜ */
            .btn-group.w-100 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .btn-group.w-100 .btn {
                border-radius: 0.375rem !important;
            }
            
            /* ëŒ€ì¶œ í•­ëª© í—¤ë” ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ì—ì„œëŠ” ë¼ë²¨ë¡œ ëŒ€ì²´) */
            .loan-tab-pane .d-flex.border-bottom {
                display: none !important;
            }
            
            /* í¼ í–‰ë“¤ ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œ ë°°ì¹˜ */
            .row.g-2 {
                --bs-gutter-x: 0;
            }
            
            .row.g-2 > [class*="col-"] {
                margin-bottom: 0.5rem;
            }
        }
        
        
        /* ê°€ë¡œëª¨ë“œ ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-container {
                flex-direction: row;
            }
            
            .pdf-viewer-column {
                flex: 0 0 45%;
            }
            
            .form-column {
                flex: 1;
                height: calc(100vh - 1rem);
            }
        }
        
        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ì—ì„œ í˜¸ë²„ íš¨ê³¼ ì œê±° */
            .btn:hover {
                transform: none;
            }
            
            /* í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€ */
            .btn:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            
            /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼) */
            .form-column::-webkit-scrollbar {
                width: 3px;
            }
            
            .form-column::-webkit-scrollbar-track {
                background: transparent;
            }
            
            .form-column::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
            }
        }
        
        /* PWA ìƒíƒœë°” ê³ ë ¤ (iOS Safari) */
        @supports (padding-top: env(safe-area-inset-top)) {
            .main-container {
                padding-top: max(0.5rem, env(safe-area-inset-top));
                padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
            }
        }
        
        /* ëª¨ë°”ì¼ìš© ëŒ€ì¶œ í•­ëª© ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .mobile-label {
            display: none;
        }
        
        @media (max-width: 576px) {
            .mobile-label {
                display: block !important;
                font-weight: 600;
                margin-bottom: 0.25rem;
                color: #495057;
                font-size: 0.8rem;
            }
        }
        
        /* Material Design í†µì¼ ìŠ¤íƒ€ì¼ */
        .md-btn {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 8px 16px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            font-size: 14px !important;
            cursor: pointer !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
            text-transform: none !important;
            letter-spacing: normal !important;
        }
        
        .md-btn:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px) !important;
        }
        
        .md-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;
        }
        
        .md-btn-primary {
            background: #2196F3 !important;
            border-color: #2196F3 !important;
            color: white !important;
        }
        
        .md-btn-primary:hover {
            background: #1976D2 !important;
            color: white !important;
        }
        
        .md-btn-danger {
            background: #f44336 !important;
            border-color: #f44336 !important;
            color: white !important;
        }
        
        .md-btn-danger:hover {
            background: #d32f2f !important;
            color: white !important;
        }
        
        .md-btn-secondary {
            background: #757575 !important;
            border-color: #757575 !important;
            color: white !important;
        }
        
        .md-btn-secondary:hover {
            background: #616161 !important;
            color: white !important;
        }
        
        .md-btn-info {
            background: #00BCD4 !important;
            border-color: #00BCD4 !important;
            color: white !important;
        }
        
        .md-btn-info:hover {
            background: #0097A7 !important;
            color: white !important;
        }
        
        .md-btn-warning {
            background: #FF9800 !important;
            border-color: #FF9800 !important;
            color: white !important;
        }
        
        .md-btn-warning:hover {
            background: #F57C00 !important;
            color: white !important;
        }
        
        .md-btn-success {
            background: #4CAF50 !important;
            border-color: #4CAF50 !important;
            color: white !important;
        }
        
        .md-btn-success:hover {
            background: #388E3C !important;
            color: white !important;
        }
        
        /* LTV ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .md-input {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            font-size: 14px !important;
            background: #fff !important;
            transition: all 0.2s ease !important;
        }
        
        .md-input:focus {
            outline: none !important;
            border-color: #2196F3 !important;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2) !important;
        }
        
        .md-ltv-btn {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 8px 12px !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
            background: #f5f5f5 !important;
            color: #333 !important;
            font-size: 14px !important;
            cursor: pointer !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
            min-width: 36px !important;
        }
        
        .md-ltv-btn:hover {
            background: #e0e0e0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px) !important;
            color: #333 !important;
        }
        
        .md-ltv-btn.danger {
            background: #f44336 !important;
            color: white !important;
            border-color: #f44336 !important;
        }
        
        .md-ltv-btn.danger:hover {
            background: #d32f2f !important;
            color: white !important;
        }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ê³¼ ëŒ€ì¶œ í•­ëª© ìŠ¤íƒ€ì¼ */
        .md-drag-handle {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 8px !important;
            background: #f5f5f5 !important;
            color: #757575 !important;
            font-size: 12px !important;
            cursor: move !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
            min-width: 32px !important;
            text-align: center !important;
            user-select: none !important;
        }
        
        .md-drag-handle:hover {
            background: #e0e0e0 !important;
            color: #333 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px) !important;
        }
        
        .md-drag-handle:active {
            transform: translateY(0) !important;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;
            background: #d5d5d5 !important;
        }
        
        .md-loan-input {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 6px 8px !important;
            font-size: 13px !important;
            background: #fff !important;
            transition: all 0.2s ease !important;
        }
        
        .md-loan-input:focus {
            outline: none !important;
            border-color: #2196F3 !important;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2) !important;
        }
        
        .md-loan-select {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            padding: 6px 8px !important;
            font-size: 13px !important;
            background: #fff !important;
            transition: all 0.2s ease !important;
        }
        
        .md-loan-select:focus {
            outline: none !important;
            border-color: #2196F3 !important;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2) !important;
        }
        
        .md-close-btn {
            border: 1px solid #f44336 !important;
            border-radius: 4px !important;
            padding: 4px 8px !important;
            background: #f44336 !important;
            color: white !important;
            font-size: 12px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12) !important;
            min-width: 24px !important;
            text-align: center !important;
        }
        
        .md-close-btn:hover {
            background: #d32f2f !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
            transform: translateY(-1px) !important;
            color: white !important;
        }
    </style>
</head>
<body>

<div class="main-container" id="main-layout-wrapper">
    <div class="pdf-viewer-column" id="pdf-column">
        <div id="upload-section">
            <div>
                <i class="bi bi-cloud-arrow-up-fill" style="font-size: 4rem; color: #6c757d;"></i>
                <h4 class="mt-3">PDF íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­</h4>
                <p class="text-muted" id="upload-text">ë“±ê¸°ë¶€ë“±ë³¸ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì‹œë©´ ì£¼ìš” ì •ë³´ê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                <div id="upload-spinner" class="spinner-border mt-3" role="status" style="display: none;"></div>
            </div>
        </div>
        <input type="file" id="file-input" accept=".pdf">
        <div id="viewer-section" style="display: none;" class="h-100 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-0 flex-shrink-0" style="padding: 0.25rem 0;">
                <h6 id="file-name-display" class="mb-0 small text-muted"></h6>
                <button id="layout-toggle-btn" class="btn md-btn md-btn-secondary"><i class="bi bi-distribute-horizontal"></i> ê°€ë¡œ ëª¨ë“œ</button>
            </div>
            <div class="pdf-iframe-container"><iframe id="pdf-viewer"></iframe></div>
        </div>
    </div>

    <div class="resize-bar" id="resize-bar"></div>

    <div class="form-column" id="form-column-wrapper">
        <div class="p-0">
            <div style="background: #6E6E6D; border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow-soft); margin-bottom: 1rem;">
                <div class="d-flex gap-2 mb-0 align-items-center">
                    <select class="form-select md-input" id="customer-history" style="flex: 2;"><option value="" selected>ê¸°ì¡´ ê³ ê° ë¶ˆëŸ¬ì˜¤ê¸°...</option></select>
                    <button class="btn md-btn md-btn-primary" id="load-customer-btn" type="button" style="flex: 0 0 auto;">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="btn md-btn md-btn-danger" id="delete-customer-btn" type="button" style="flex: 0 0 auto;">ì‚­ì œ</button>
                    <button class="btn md-btn md-btn-warning" type="button" id="reset-btn" style="flex: 0 0 auto;">âœ¨ ì „ì²´ ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div id="basic-info-form" style="background: #F2EDD7; border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow-soft); margin-bottom: 1rem;">
                <div class="mb-2"><label for="address">ì£¼ì†Œ</label><input type="text" class="form-control form-field md-input" id="address"></div>
                <div class="row g-2 mb-2">
                    <div class="col-md-6"><label for="customer_name">ê³ ê°ëª… & ìƒë…„ì›”ì¼</label><input type="text" class="form-control form-field md-input" id="customer_name"></div>
                    <div class="col-md-6"><label for="price_type_field">ì‹œì„¸ì ìš©</label><input type="text" class="form-control form-field md-input fw-bold" id="price_type_field" readonly></div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-6"><label for="deduction_region">ë°©ê³µì œ ì§€ì—­</label><select class="form-select form-field md-loan-select" id="deduction_region">
                        <option value="0" selected>ì§€ì—­ ì„ íƒ...</option>
                        {% for region, amount in region_map.items() %}<option value="{{ amount }}">{{ region }}</option>{% endfor %}
                    </select></div>
                    <div class="col-md-6"><label for="deduction_amount">ë°©ê³µì œ ê¸ˆì•¡(ë§Œ)</label><input type="text" class="form-control form-field manwon-format md-input" id="deduction_amount"></div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-md-6"><label for="kb_price">KB ì‹œì„¸(ë§Œ)</label><input type="text" class="form-control form-field manwon-format md-input" id="kb_price"></div>
                    <div class="col-md-6"><label for="area">ì „ìš©ë©´ì (ã¡)</label><input type="text" class="form-control form-field md-input" id="area"></div>
                </div>
                
                <div class="d-flex gap-2 w-100 mt-3"><a href="https://kbland.kr/map?xy=37.5205559,126.9265729,17" target="_blank" class="btn md-btn md-btn-warning flex-fill">KBì‹œì„¸</a><a href="https://www.howsmuch.com" target="_blank" class="btn md-btn md-btn-info flex-fill">í•˜ìš°ìŠ¤ë¨¸ì¹˜</a><a href="http://www.iros.go.kr" target="_blank" class="btn md-btn md-btn-secondary flex-fill">ì¸í„°ë„·ë“±ê¸°ì†Œ</a></div>

            </div>
            
            <!-- LTV ë¹„ìœ¨ì„ íƒ­ ë°–ìœ¼ë¡œ ë…¸ì¶œ -->
            <div style="background: #F2EDD7; border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow-soft); border: 2px solid transparent; transition: border-color 0.3s ease;" onmouseover="this.style.borderColor='#A4193D'" onmouseout="this.style.borderColor='transparent'">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="d-flex align-items-center gap-2">
                            <label for="ltv1" class="mb-0" style="white-space: nowrap;">ğŸ“Š LTV ë¹„ìœ¨ â‘ </label>
                            <div class="d-flex gap-1">
                                <button class="md-ltv-btn" type="button" onclick="adjustLtvValue('ltv1', -5)">-</button>
                                <button class="md-ltv-btn" type="button" onclick="adjustLtvValue('ltv1', 5)">+</button>
                                <input type="text" class="form-control form-field text-center md-input" id="ltv1" value="80" style="flex: 1;">
                                <button class="md-ltv-btn danger" type="button" onclick="clearLtvValue('ltv1')">Ã—</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center gap-2">
                            <label for="ltv2" class="mb-0" style="white-space: nowrap;">ğŸ“Š LTV ë¹„ìœ¨ â‘¡</label>
                            <div class="d-flex gap-1">
                                <button class="md-ltv-btn" type="button" onclick="adjustLtvValue('ltv2', -5)">-</button>
                                <button class="md-ltv-btn" type="button" onclick="adjustLtvValue('ltv2', 5)">+</button>
                                <input type="text" class="form-control form-field text-center md-input" id="ltv2" value="" style="flex: 1;">
                                <button class="md-ltv-btn danger" type="button" onclick="clearLtvValue('ltv2')">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
                <ul class="nav nav-tabs" id="myTab" role="tablist" style="border-bottom: 0;">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="loan-tab" data-bs-toggle="tab" data-bs-target="#loan-tab-pane" type="button" role="tab">ëŒ€ì¶œ í•­ëª©</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="fee-tab" data-bs-toggle="tab" data-bs-target="#fee-tab-pane" type="button" role="tab">ì»¨ì„¤íŒ…/ë¸Œë¦¿ì§€</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="interest-calc-tab" data-bs-toggle="tab" data-bs-target="#interest-calc-tab-pane" type="button" role="tab">ì´ì ê³„ì‚°ê¸°</button></li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="share-limit-tab" data-bs-toggle="tab" data-bs-target="#share-limit-tab-pane" type="button" role="tab">
                        ì§€ë¶„ í•œë„ ê³„ì‚°ê¸°
                      </button>
                    </li>
                </ul>
                <div>
                    <button type="button" class="btn md-btn md-btn-secondary" id="add-loan-btn">+ ëŒ€ì¶œ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>

            <div class="tab-content" style="background: #F2EDD7; border-radius: 12px; padding: 0.5rem;">
                <div class="tab-pane fade show active" id="loan-tab-pane" role="tabpanel">
                    <!-- âœ¨ í—¤ë” ë ˆì´ì•„ì›ƒ ìˆ˜ì •: ë“œë˜ê·¸ í•¸ë“¤ìš© ê³µê°„ ì¶”ê°€ -->
                    <div class="d-flex border-bottom pb-2 mb-1 fw-bold align-items-center" style="font-size: 0.85rem; height: 38px;">
                        <div style="flex: 0 0 24px; display: flex; align-items: center; justify-content: center;"></div>
                        <div style="flex: 0 0 30%; display: flex; align-items: center;">ì„¤ì •ì</div>
                        <div style="flex: 0 0 15%; margin-left: 0.5rem; display: flex; align-items: center;">ì±„ê¶Œìµœê³ ì•¡(ë§Œ)</div>
                        <div style="flex: 0 0 7%; margin-left: 0.5rem; display: flex; align-items: center;">ë¹„ìœ¨(%)</div>
                        <div style="flex: 0 0 15%; margin-left: 0.5rem; display: flex; align-items: center;">ì›ê¸ˆ(ë§Œ)</div>
                        <div style="flex: 0 0 12%; margin-left: 0.5rem; display: flex; align-items: center;">êµ¬ë¶„</div>
                        <div style="flex: 0 0 8%; margin-left: 0.5rem; display: flex; align-items: center; justify-content: center;"></div>
                    </div>
                    <div id="loan-items-container"></div>
                </div>
                <div class="tab-pane fade" id="fee-tab-pane" role="tabpanel">
                    <div class="row g-2">
                        <div class="col"><label>ì»¨ì„¤íŒ…(ë§Œ)</label><input type="text" class="form-control form-field manwon-format md-input" id="consult_amt" value="0"></div>
                        <div class="col"><label>(%)</label><input type="text" class="form-control form-field md-input" id="consult_rate" value="1.5"></div>
                        <div class="col"><label>ë¸Œë¦¿ì§€(ë§Œ)</label><input type="text" class="form-control form-field manwon-format md-input" id="bridge_amt" value="0"></div>
                        <div class="col"><label>(%)</label><input type="text" class="form-control form-field md-input" id="bridge_rate" value="0.7"></div>
                    </div>
                </div>
                <div class="tab-pane fade" id="interest-calc-tab-pane" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="interest-loan-amount" class="form-label">ëŒ€ì¶œê¸ˆì•¡ (ë§Œì›)</label>
                            <input type="text" class="form-control md-input" id="interest-loan-amount" placeholder="">
                        </div>
                        <div class="col-md-6">
                            <label for="interest-annual-rate" class="form-label">ì—°ì´ìœ¨ (%)</label>
                            <input type="text" class="form-control md-input" id="interest-annual-rate" placeholder="">
                        </div>
                    </div>
                    <div class="row g-3 mt-3">
                        <div class="col-md-4">
                            <label class="form-label">í•˜ë£¨ ì´ì (ì›)</label>
                            <input type="text" class="form-control md-input" id="interest-daily-result" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">í•œë‹¬ ì´ì (ì›)</label>
                            <input type="text" class="form-control md-input" id="interest-monthly-result" readonly>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">1ë…„ ì´ì (ì›)</label>
                            <input type="text" class="form-control md-input" id="interest-yearly-result" readonly>
                        </div>
                    </div>
                    <hr class="my-4">
                    <h6 class="mb-3 text-success">ì›ê¸ˆ ë¶„í• Â·ë§Œê¸°ì¼ì‹œ ëŒ€ì¶œ ê³„ì‚°ê¸°</h6>
                    <!-- ëŒ€ì¶œê¸ˆ, ì—°ì´ìœ¨ í•„ë“œ ì‚­ì œí•˜ê³  ë°”ë¡œ ì›ê¸ˆ ë¶„í•  ë¹„ìœ¨ë¶€í„° ì‹œì‘ -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label for="balloon-principal-pct" class="form-label">ì›ê¸ˆ ë¶„í•  ë¹„ìœ¨ (X%)</label>
                            <input type="number" class="form-control md-input" id="balloon-principal-pct" value="7" min="0" max="100" step="0.1">
                        </div>
                        <div class="col-md-6">
                            <label for="balloon-months" class="form-label">ê¸°ê°„ (ê°œì›”)</label>
                            <input type="number" class="form-control md-input" id="balloon-months" value="60" min="1" step="1">
                        </div>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label text-success">ë§¤ì›” ì›ê¸ˆ</label>
                            <input type="text" class="form-control bg-light md-input" id="balloon-monthly-principal" readonly>
                            <small class="text-muted">ì˜ˆ) 3ì–µ, 7%, 60ê°œì›” â†’ 350,000ì›</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-info">ì²« ë‹¬ ë‚©ì…ì•¡</label>
                            <input type="text" class="form-control bg-light md-input" id="balloon-first-payment" readonly>
                            <small class="text-muted" id="balloon-first-breakdown">(ì›ê¸ˆ + ì´ì)</small>
                        </div>
                    </div>
                </div>
                <!-- ====================================================== -->
                <!-- âœ… [ìˆ˜ì •] ì§€ë¶„ í•œë„ ê³„ì‚°ê¸° íƒ­ ë‚´ìš© ì‹œì‘ -->
                <!-- ====================================================== -->
                <div class="tab-pane fade" id="share-limit-tab-pane" role="tabpanel">
                    <h6 class="mb-3">ì°¨ì£¼ ì„ íƒ</h6>
                    
                    <!-- ê³µìœ ì 1 ì •ë³´ ì…ë ¥ -->
                    <div class="row mb-2">
                        <div class="col-auto pe-2">
                          <input type="radio" name="share-borrower" value="1" id="share-borrower-1" style="transform: scale(1.3); margin-top: 32px;">
                        </div>
                        <div class="col-5">
                          <label for="share-customer-name-1">ê³µìœ ì 1 ê³ ê°ëª… & ìƒë…„ì›”ì¼</label>
                          <input type="text" class="form-control md-input" id="share-customer-name-1" placeholder=>
                        </div>
                        <div class="col">
                          <label for="share-customer-birth-1">ì§€ë¶„ìœ¨</label>
                          <input type="text" class="form-control md-input" id="share-customer-birth-1">
                        </div>
                    </div>

                    <!-- ê³µìœ ì 2 ì •ë³´ ì…ë ¥ -->
                    <div class="row mb-2">
                        <div class="col-auto pe-2">
                          <input type="radio" name="share-borrower" value="2" id="share-borrower-2" style="transform: scale(1.3); margin-top: 32px;">
                        </div>
                        <div class="col-5">
                          <label for="share-customer-name-2">ê³µìœ ì 2 ê³ ê°ëª… & ìƒë…„ì›”ì¼</label>
                          <input type="text" class="form-control md-input" id="share-customer-name-2" placeholder=>
                        </div>
                        <div class="col">
                          <label for="share-customer-birth-2">ì§€ë¶„ìœ¨</label>
                          <input type="text" class="form-control md-input" id="share-customer-birth-2" placeholder=>
                        </div>
                    </div>
                    
                    
                </div>
                <!-- ====================================================== -->
                <!-- âœ… [ìˆ˜ì •] ì§€ë¶„ í•œë„ ê³„ì‚°ê¸° íƒ­ ë‚´ìš© ë -->
                <!-- ====================================================== -->
            </div>                
            <hr class="my-2">
            <div style="background: #6E6E6D; border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow-soft); margin-bottom: 1rem;">
                <textarea class="form-control md-input" id="generated-memo" rows="15" placeholder="ì…ë ¥/ìˆ˜ì • ì‹œ ì ì‹œ í›„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìš”ì•½ ë©”ëª¨ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."></textarea>
            </div>
            
            <div style="background: #F2EDD7; border-radius: 12px; padding: 0.5rem; box-shadow: var(--shadow-soft);">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button class="btn md-btn md-btn-primary" id="save-new-btn" type="button">ì‹ ê·œ ê³ ê°ìœ¼ë¡œ ì €ì¥</button>
                    <button class="btn md-btn md-btn-success" id="update-btn" type="button">ê¸°ì¡´ ê³ ê° ì •ë³´ ìˆ˜ì •</button>
                </div>
            </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let loanItemCounter = 0;
    let memoDebounceTimeout;

    // ë ˆì´ì•„ì›ƒ ì„¤ì • ì €ì¥/ë³µì› ê¸°ëŠ¥
    function saveLayoutSettings() {
        const mainContainer = document.getElementById('main-layout-wrapper');
        const pdfColumn = document.getElementById('pdf-column');
        const formColumn = document.getElementById('form-column-wrapper');
        const isHorizontal = mainContainer.classList.contains('horizontal-mode');
        
        const layoutSettings = {
            isHorizontalMode: isHorizontal,
            pdfColumnWidth: pdfColumn.style.width || (isHorizontal ? '100%' : '62.5%'),
            pdfColumnHeight: pdfColumn.style.height || (isHorizontal ? '60%' : 'calc(100vh - 2rem)'),
            formColumnWidth: formColumn.style.width || (isHorizontal ? '100%' : '37.5%'),
            formColumnHeight: formColumn.style.height || (isHorizontal ? '38%' : 'calc(100vh - 2rem)'),
            timestamp: Date.now()
        };
        
        localStorage.setItem('ltvLayoutSettings', JSON.stringify(layoutSettings));
    }

    function loadLayoutSettings() {
        try {
            const saved = localStorage.getItem('ltvLayoutSettings');
            if (!saved) return;
            
            const settings = JSON.parse(saved);
            const mainContainer = document.getElementById('main-layout-wrapper');
            const btn = document.getElementById('layout-toggle-btn');
            const pdfColumn = document.getElementById('pdf-column');
            const formColumn = document.getElementById('form-column-wrapper');
            
            // ì €ì¥ëœ ì„¤ì •ì´ 24ì‹œê°„ ì´ë‚´ì¸ì§€ í™•ì¸
            const isRecent = (Date.now() - settings.timestamp) < (24 * 60 * 60 * 1000);
            if (!isRecent) return;
            
            // ë ˆì´ì•„ì›ƒ ëª¨ë“œ ë³µì›
            if (settings.isHorizontalMode) {
                mainContainer.classList.add('horizontal-mode');
                btn.innerHTML = '<i class="bi bi-distribute-vertical"></i> ì„¸ë¡œ ëª¨ë“œ';
            } else {
                mainContainer.classList.remove('horizontal-mode');
                btn.innerHTML = '<i class="bi bi-distribute-horizontal"></i> ê°€ë¡œ ëª¨ë“œ';
            }
            
            // ì»¬ëŸ¼ í¬ê¸° ë³µì›
            pdfColumn.style.width = settings.pdfColumnWidth;
            pdfColumn.style.height = settings.pdfColumnHeight;
            formColumn.style.width = settings.formColumnWidth;
            formColumn.style.height = settings.formColumnHeight;
            
        } catch (error) {
            console.error('ë ˆì´ì•„ì›ƒ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ê³ ê¸‰ ê¸ˆì•¡ íŒŒì‹± í•¨ìˆ˜
    function parseAdvancedAmount(text) {
        if (!text) return 0;
        
        let cleanText = text.replace(/,/g, '').trim();
        
        // 1. í•œê¸€ ê¸ˆì•¡ ì²˜ë¦¬ (ì–µ, ë§Œ, ì²œ, ì› í¬í•¨)
        if (/ì–µ|ë§Œ|ì²œ|ì›/.test(cleanText)) {
            return parseKoreanAmountAdvanced(cleanText);
        }
        
        // 2. ì› ë‹¨ìœ„ ê¸ˆì•¡ ì²˜ë¦¬ (8ìë¦¬ ì´ìƒì´ê±°ë‚˜ 'ì›'ìœ¼ë¡œ ëë‚˜ëŠ” ê²½ìš°)
        if (cleanText.endsWith('ì›') || cleanText.replace(/[^\d]/g, '').length >= 8) {
            const numOnly = cleanText.replace(/[^\d]/g, '');
            if (numOnly) {
                const wonAmount = parseInt(numOnly);
                // ì›ì„ ë§Œì›ìœ¼ë¡œ ë³€í™˜
                return Math.floor(wonAmount / 10000);
            }
        }
        
        // 3. ì¼ë°˜ ìˆ«ì ì²˜ë¦¬
        const numOnly = cleanText.replace(/[^\d]/g, '');
        return numOnly ? parseInt(numOnly) : 0;
    }

    // í•œê¸€ ê¸ˆì•¡ ê³ ê¸‰ íŒŒì‹±
    function parseKoreanAmountAdvanced(text) {
        let total = 0;
        let remainingText = text;
        
        // ì–µ ë‹¨ìœ„ ì²˜ë¦¬
        const eokMatch = remainingText.match(/(\d+)ì–µ/);
        if (eokMatch) {
            total += parseInt(eokMatch[1]) * 10000;
            remainingText = remainingText.replace(eokMatch[0], '');
        }
        
        // ì²œë§Œ ë‹¨ìœ„ ì²˜ë¦¬ (ì˜ˆ: 2ì²œë§Œ = 2000ë§Œ)
        const cheonmanMatch = remainingText.match(/(\d+)ì²œë§Œ/);
        if (cheonmanMatch) {
            total += parseInt(cheonmanMatch[1]) * 1000;
            remainingText = remainingText.replace(cheonmanMatch[0], '');
        }
        
        // ë§Œ ë‹¨ìœ„ ì²˜ë¦¬
        const manMatch = remainingText.match(/(\d+)ë§Œ/);
        if (manMatch) {
            total += parseInt(manMatch[1]);
            remainingText = remainingText.replace(manMatch[0], '');
        }
        
        // ì²œ ë‹¨ìœ„ ì²˜ë¦¬ (ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜)
        const cheonMatch = remainingText.match(/(\d+)ì²œ/);
        if (cheonMatch) {
            total += parseInt(cheonMatch[1]) / 10; // ì²œì›ì„ ë§Œì›ìœ¼ë¡œ ë³€í™˜
            remainingText = remainingText.replace(cheonMatch[0], '');
        }
        
        return Math.floor(total);
    }

    // í•œê¸€ ê¸ˆì•¡ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    function parseKoreanNumberString(text) {
        return parseAdvancedAmount(text);
    }

    // ì› ë‹¨ìœ„ë¥¼ ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function convertWonToManwon(wonAmount) {
        return parseAdvancedAmount(wonAmount);
    }

    // ì±„ê¶Œìµœê³ ì•¡ê³¼ ë¹„ìœ¨ë¡œ ì›ê¸ˆ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    function calculatePrincipalFromRatio(maxAmount, ratio) {
        const maxAmt = parseFloat(String(maxAmount).replace(/,/g, '')) || 0;
        const ratioVal = parseFloat(ratio) || 120;
        
        if (ratioVal <= 0) return 0;
        
        // ì›ê¸ˆ = ì±„ê¶Œìµœê³ ì•¡ Ã· (ë¹„ìœ¨/100)
        return Math.round(maxAmt / (ratioVal / 100));
    }

    // âœ¨ ë“œë˜ê·¸ì•¤ë“œë¡­ ê¸°ëŠ¥ ì¶”ê°€ - Material Design ìŠ¤íƒ€ì¼
    function initializeDragAndDrop() {
        const container = document.getElementById('loan-items-container');
        
        // ë“œë˜ê·¸ í•¸ë“¤ì—ë§Œ ë“œë˜ê·¸ ì´ë²¤íŠ¸ ì¶”ê°€
        container.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('md-drag-handle') || e.target.classList.contains('drag-handle')) {
                const loanItem = e.target.closest('.loan-item');
                loanItem.draggable = true;
            }
        });
        
        container.addEventListener('mouseup', (e) => {
            // ë§ˆìš°ìŠ¤ë¥¼ ë–¼ë©´ ëª¨ë“  í•­ëª©ì˜ draggableì„ falseë¡œ
            container.querySelectorAll('.loan-item').forEach(item => {
                item.draggable = false;
            });
        });
        
        container.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('loan-item')) {
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            }
        });
        
        container.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('loan-item')) {
                e.target.classList.remove('dragging');
            }
        });
        
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            const draggingItem = container.querySelector('.dragging');
            const siblings = [...container.querySelectorAll('.loan-item:not(.dragging)')];
            
            const nextSibling = siblings.find(sibling => {
                return e.clientY <= sibling.getBoundingClientRect().top + sibling.getBoundingClientRect().height / 2;
            });
            
            container.insertBefore(draggingItem, nextSibling);
        });
        
        container.addEventListener('drop', (e) => {
            e.preventDefault();
            // ë“œë¡­ í›„ ë©”ëª¨ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                triggerMemoGeneration();
            }, 100);
        });
    }

    // createLoanItemHTML í•¨ìˆ˜ - ë“œë˜ê·¸ í•¸ë“¤ ì¶”ê°€
    function createLoanItemHTML(index, loan = {}) {
        const formatValue = (val) => {
            if (!val) return '0';
            const numValue = Number(String(val).replace(/,/g, ''));
            return numValue ? numValue.toLocaleString() : '0';
        };
        
        return `
        <div id="loan-item-${index}" class="loan-item d-flex align-items-center py-2 border-bottom" draggable="false">
            <div style="flex: 0 0 24px;">
                <div class="drag-handle md-drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</div>
            </div>
            <div style="flex: 0 0 30%;">
                <div class="mobile-label">ì„¤ì •ì</div>
                <input type="text" class="form-control form-control-sm loan-input form-field md-loan-input" name="lender" value="${loan.lender || ''}">
            </div>
            <div style="flex: 0 0 15%; margin-left: 0.5rem;">
                <div class="mobile-label">ì±„ê¶Œìµœê³ ì•¡(ë§Œ)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field manwon-format md-loan-input" name="max_amount" value="${formatValue(loan.max_amount)}">
            </div>
            <div style="flex: 0 0 7%; margin-left: 0.5rem;">
                <div class="mobile-label">ë¹„ìœ¨(%)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field md-loan-input" name="ratio" value="${loan.ratio || '120'}">
            </div>
            <div style="flex: 0 0 15%; margin-left: 0.5rem;">
                <div class="mobile-label">ì›ê¸ˆ(ë§Œ)</div>
                <input type="text" class="form-control form-control-sm loan-input form-field manwon-format md-loan-input" name="principal" value="${formatValue(loan.principal)}">
            </div>
            <div style="flex: 0 0 12%; margin-left: 0.5rem;">
                <div class="mobile-label">êµ¬ë¶„</div>
                <select class="form-select form-select-sm loan-input form-field md-loan-select" name="status">
                    <option value="ìœ ì§€" ${loan.status === 'ìœ ì§€' ? 'selected' : ''}>ìœ ì§€</option>
                    <option value="ëŒ€í™˜" ${loan.status === 'ëŒ€í™˜' ? 'selected' : ''}>ëŒ€í™˜</option>
                    <option value="ì„ ë§ì†Œ" ${loan.status === 'ì„ ë§ì†Œ' ? 'selected' : ''}>ì„ ë§ì†Œ</option>
                    <option value="í‡´ê±°ìê¸ˆ" ${loan.status === 'í‡´ê±°ìê¸ˆ' ? 'selected' : ''}>í‡´ê±°ìê¸ˆ</option>
                    <option value="ë™ì˜" ${loan.status === 'ë™ì˜' ? 'selected' : ''}>ë™ì˜</option>
                    <option value="ë¹„ë™ì˜" ${loan.status === 'ë¹„ë™ì˜' ? 'selected' : ''}>ë¹„ë™ì˜</option>
                </select>
            </div>
            <div style="flex: 0 0 8%; margin-left: 0.5rem; display: flex; justify-content: flex-end;" class="text-center">
                <button type="button" class="md-btn md-btn-primary" aria-label="Close" onclick="removeLoanItem(${index})" style="padding: 4px 8px; font-size: 12px; min-width: 24px;">Ã—</button>
            </div>
        </div>`;
    }

    // âœ¨ [ì‹ ê·œ] ë‹¨ìˆœ ì´ì ê³„ì‚° í•¨ìˆ˜
    function calculateSimpleInterest() {
        // ì…ë ¥ ìš”ì†Œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');

        // ì½¤ë§ˆ(,) ì œê±°í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
        const principalManwon = parseInt(loanAmountInput.value.replace(/,/g, '')) || 0;
        const principal = principalManwon * 10000; // ì› ë‹¨ìœ„ë¡œ ë³€í™˜
        const annualRate = parseFloat(annualRateInput.value) || 0;

        // ê²°ê³¼ í‘œì‹œ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const dailyResultEl = document.getElementById('interest-daily-result');
        const monthlyResultEl = document.getElementById('interest-monthly-result');
        const yearlyResultEl = document.getElementById('interest-yearly-result');

        // ì…ë ¥ê°’ì´ ìœ íš¨í•  ë•Œë§Œ ê³„ì‚°
        if (principal > 0 && annualRate > 0) {
            const yearlyInterest = Math.floor(principal * (annualRate / 100));
            const monthlyInterest = Math.floor(yearlyInterest / 12);
            const dailyInterest = Math.floor(yearlyInterest / 365);

            // ê³„ì‚°ëœ ê°’ì„ ì½¤ë§ˆì™€ í•¨ê»˜ 'ì›' ë‹¨ìœ„ë¡œ í‘œì‹œ
            yearlyResultEl.value = yearlyInterest.toLocaleString() + 'ì›';
            monthlyResultEl.value = monthlyInterest.toLocaleString() + 'ì›';
            dailyResultEl.value = dailyInterest.toLocaleString() + 'ì›';
        } else {
            // ì…ë ¥ê°’ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ê²°ê³¼ë¥¼ ''ìœ¼ë¡œ ì´ˆê¸°í™”
            yearlyResultEl.value = '';
            monthlyResultEl.value = '';
            dailyResultEl.value = '';
        }
    }

    // âœ¨ ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜
    function addLoanItem(loan = {}) {
        const container = document.getElementById('loan-items-container');
        container.insertAdjacentHTML('beforeend', createLoanItemHTML(loanItemCounter++, loan));
        attachEventListenersForLoanItems();
    }

    // ëŒ€ì¶œ í•­ëª© ì œê±°
    function removeLoanItem(index) {
        document.getElementById(`loan-item-${index}`)?.remove();
        triggerMemoGeneration();
    }
    
    // ìˆ«ì ìë™ í¬ë§· (ê°œì„ ëœ ê³ ê¸‰ ê¸ˆì•¡ ì²˜ë¦¬)
    function formatManwonValue(e) {
        const field = e.target;
        let value = field.value.trim();
        let parsedValue = 0;

        // ë¹ˆ ê°’ ì²˜ë¦¬
        if (!value) {
            field.value = '';
            triggerMemoGeneration();
            return;
        }

        // '+' ê¸°í˜¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ê³„ì‚°
        if (value.includes('+')) {
            const terms = value.split('+');
            parsedValue = terms.reduce((acc, term) => {
                return acc + parseAdvancedAmount(term.trim());
            }, 0);
        } else {
            parsedValue = parseAdvancedAmount(value);
        }
        
        // ê³„ì‚°ëœ ê°’ì„ ì…ë ¥ì°½ì— ë‹¤ì‹œ ì„¤ì •
        field.value = parsedValue > 0 ? parsedValue.toLocaleString() : '';

        // ë©”ëª¨ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
        triggerMemoGeneration();
    }

    // [ìˆ˜ì •ë¨] ëŒ€ì¶œ í•­ëª© ìë™ ê³„ì‚° (ì›ê¸ˆ-ìµœê³ ì•¡) - í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ
    function handleAutoLoanCalc(event) {
        const target = event.target;
        const loanItem = target.closest('.loan-item');
        if (!loanItem) return;

        const maxAmountInput = loanItem.querySelector('[name="max_amount"]');
        const ratioInput = loanItem.querySelector('[name="ratio"]');
        const principalInput = loanItem.querySelector('[name="principal"]');

        let maxAmount = parseFloat(maxAmountInput.value.replace(/,/g, '')) || 0;
        let ratio = parseFloat(ratioInput.value) || 0;
        let principal = parseFloat(principalInput.value.replace(/,/g, '')) || 0;

        if (target.name === 'principal') {
            // ì›ê¸ˆì´ ë°”ë€Œë©´ ë¹„ìœ¨ì— ë”°ë¼ ìµœê³ ì•¡ ì—­ì‚°
            if (principal > 0 && ratio > 0) {
                maxAmount = Math.round(principal * (ratio / 100));
                maxAmountInput.value = maxAmount.toLocaleString();
            }
        } else {
            // ìµœê³ ì•¡ ë˜ëŠ” ë¹„ìœ¨ì´ ë°”ë€Œë©´ ì›ê¸ˆ ê³„ì‚°
            if (maxAmount > 0 && ratio > 0) {
                principal = Math.round(maxAmount / (ratio / 100));
                principalInput.value = principal.toLocaleString();
            }
        }
        triggerMemoGeneration();
    }
    
    // [ì‹ ê·œ] ì±„ê¶Œìµœê³ ì•¡ ì…ë ¥ ì‹œ ì„œë²„ APIë¥¼ í†µí•´ ê¸ˆì•¡ ë³€í™˜ ë° ì›ê¸ˆ ìë™ê³„ì‚°
    async function handleApiLoanConversion(event) {
        const maxAmountInput = event.target;
        const loanItem = maxAmountInput.closest('.loan-item');
        if (!loanItem) return;

        const ratioInput = loanItem.querySelector('[name="ratio"]');
        const principalInput = loanItem.querySelector('[name="principal"]');

        const loanData = {
            max_amount: maxAmountInput.value,
            ratio: ratioInput.value
        };

        try {
            const response = await fetch('/api/convert_loan_amount', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loanData)
            });

            if (!response.ok) throw new Error('API call failed');
            const result = await response.json();

            if (result.success && result.converted_data) {
                const data = result.converted_data;
                maxAmountInput.value = data.max_amount ? parseInt(data.max_amount).toLocaleString() : '0';
                principalInput.value = data.principal ? parseInt(data.principal).toLocaleString() : '0';
            }
        } catch (error) {
            console.error('Error during loan conversion:', error);
            // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ, í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
            handleAutoLoanCalc(event); 
        } finally {
            triggerMemoGeneration();
        }
    }
    
    // âœ¨ [ì‹ ê·œ] ë°©ê³µì œ ë° ì„ì°¨ì¸(ë™ì˜/ë¹„ë™ì˜) ìƒíƒœì— ë”°ë¥¸ ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function checkTenantDeductionWarning() {
        const deductionRegionSelect = document.getElementById('deduction_region');
        // "ì§€ì—­ ì„ íƒ..." ë˜ëŠ” "ë°©ê³µì œ ì—†ìŒ" ë“±ì˜ ê¸°ë³¸ê°’(value="0")ì´ ì•„ë‹Œ ê²½ìš°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        const isDeductionSelected = deductionRegionSelect.value && deductionRegionSelect.value !== '0';

        if (!isDeductionSelected) {
            return; // ë°©ê³µì œ ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê²€ì‚¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
        }

        const tenantStatuses = ['ë™ì˜', 'ë¹„ë™ì˜'];
        let hasTenantLoan = false;
        // í˜„ì¬ í™”ë©´ì— ìˆëŠ” ëª¨ë“  ëŒ€ì¶œ í•­ëª©ì˜ 'ì§„í–‰' ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        document.querySelectorAll('.loan-item [name="status"]').forEach(statusSelect => {
            if (tenantStatuses.includes(statusSelect.value)) {
                hasTenantLoan = true;
            }
        });

        // ë°©ê³µì œ ì§€ì—­ì´ ì„ íƒë˜ì—ˆê³ , 'ë™ì˜' ë˜ëŠ” 'ë¹„ë™ì˜' ìƒíƒœì˜ ëŒ€ì¶œì´ í•˜ë‚˜ë¼ë„ ìˆë‹¤ë©´ ê²½ê³  ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        if (hasTenantLoan) {
            alert("ì„ì°¨ì¸ì´ ê±°ì£¼í•˜ê³  ìˆëŠ” ë¬¼ê±´ì§€ëŠ” ë°©ê³µì œê¸ˆì•¡ì„ ì…ë ¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì„¸í‡´ê±°ì—¬ë¶€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”");
        }
    }

    // [ìˆ˜ì •ë¨] ë™ì  ìƒì„±ëœ ëŒ€ì¶œ í•­ëª©ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    function attachEventListenersForLoanItems() {
        document.querySelectorAll('.loan-item').forEach(item => {
            const maxAmountInput = item.querySelector('[name="max_amount"]');
            const ratioInput = item.querySelector('[name="ratio"]');
            const principalInput = item.querySelector('[name="principal"]');
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ëª¨ë‘ ì œê±°í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
            const newMaxAmountInput = maxAmountInput.cloneNode(true);
            const newRatioInput = ratioInput.cloneNode(true);
            const newPrincipalInput = principalInput.cloneNode(true);

            maxAmountInput.parentNode.replaceChild(newMaxAmountInput, maxAmountInput);
            ratioInput.parentNode.replaceChild(newRatioInput, ratioInput);
            principalInput.parentNode.replaceChild(newPrincipalInput, principalInput);

            // [í•µì‹¬] ì±„ê¶Œìµœê³ ì•¡: í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ì„œë²„ APIë¡œ ë³€í™˜ ìš”ì²­
            newMaxAmountInput.addEventListener('blur', handleApiLoanConversion);
            
            // ë¹„ìœ¨: ê°’ì´ ë³€ê²½ë  ë•Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì›ê¸ˆ ì¦‰ì‹œ ì¬ê³„ì‚°
            newRatioInput.addEventListener('change', handleAutoLoanCalc);
            
            // ì›ê¸ˆ: í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ìˆ«ì í¬ë§·íŒ… / ê°’ì´ ë³€ê²½ë  ë•Œ ìµœê³ ì•¡ ì—­ì‚°
            newPrincipalInput.addEventListener('blur', formatManwonValue);
            newPrincipalInput.addEventListener('change', handleAutoLoanCalc);

            // ëª¨ë“  í•­ëª©ì˜ ê°’ì´ ë³€ê²½ë˜ë©´ ë©”ëª¨ ì—…ë°ì´íŠ¸
            item.querySelectorAll('.loan-input').forEach(input => {
                // âœ¨ [ìˆ˜ì •] 'change' ì´ë²¤íŠ¸ì— ê²½ê³  í™•ì¸ ë¡œì§ ì¶”ê°€
                input.addEventListener('change', (e) => {
                    // ë§Œì•½ ë³€ê²½ëœ í•„ë“œê°€ 'status'ë¼ë©´, ì„ì°¨ì¸/ë°©ê³µì œ ê²½ê³ ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
                    if (e.target.name === 'status') {
                        checkTenantDeductionWarning();
                    }
                    // ê¸°ì¡´ì˜ ë©”ëª¨ ìƒì„± í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
                    triggerMemoGeneration();
                });
            });
        });
    }

    // ëª¨ë“  í¼ ë°ì´í„° ìˆ˜ì§‘
    function collectAllData() {
        const regionSelect = document.getElementById('deduction_region');
        const selectedRegionText = regionSelect.options[regionSelect.selectedIndex].text;
        const loanItems = Array.from(document.querySelectorAll('.loan-item')).map(item => ({
            lender: item.querySelector('[name="lender"]').value, 
            status: item.querySelector('[name="status"]').value,
            max_amount: item.querySelector('[name="max_amount"]').value, 
            principal: item.querySelector('[name="principal"]').value,
            ratio: item.querySelector('[name="ratio"]').value,
        }));
        return {
            inputs: {
                customer_name: document.getElementById('customer_name').value, 
                address: document.getElementById('address').value,
                kb_price: document.getElementById('kb_price').value, 
                area: document.getElementById('area').value,
                deduction_region_text: selectedRegionText, 
                deduction_amount: document.getElementById('deduction_amount').value,
                ltv_rates: [document.getElementById('ltv1').value, document.getElementById('ltv2').value],
            }, 
            fees: {
                consult_amt: document.getElementById('consult_amt').value, 
                consult_rate: document.getElementById('consult_rate').value,
                bridge_amt: document.getElementById('bridge_amt').value, 
                bridge_rate: document.getElementById('bridge_rate').value,
            }, 
            loans: loanItems
        };
    }
    
    // ë©”ëª¨ ìƒì„± ìš”ì²­ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    function triggerMemoGeneration() {
        clearTimeout(memoDebounceTimeout);
        memoDebounceTimeout = setTimeout(generateMemo, 800); 
    }

    // ë©”ëª¨ ìƒì„± ë° í•˜ì•ˆê°€/ì¼ë°˜ê°€ í‘œì‹œ
    async function generateMemo() {
        const memoArea = document.getElementById('generated-memo');
        memoArea.placeholder
        const data = collectAllData();
        const requestData = { inputs: data.inputs, loans: data.loans, fees: data.fees };
        try {
            const response = await fetch('/api/generate_text_memo', { 
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestData)
            });
            const result = await response.json();
            memoArea.value = result.memo
            
            const priceTypeField = document.getElementById('price_type_field');
            if (result.price_type) {
                priceTypeField.value = result.price_type;
                
                // âœ¨ 1. ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ë¨¼ì € ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
                priceTypeField.classList.remove('text-danger', 'text-primary');

                // âœ¨ 2. ì‹œì„¸ íƒ€ì…ì— ë”°ë¼ ì ì ˆí•œ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                if (result.price_type.includes('ì¼ë°˜ê°€')) {
                    priceTypeField.classList.add('text-primary'); // 'ì¼ë°˜ê°€'ëŠ” íŒŒë€ìƒ‰
                } else if (result.price_type.includes('í•˜ì•ˆê°€')) {
                    priceTypeField.classList.add('text-danger');  // 'í•˜ì•ˆê°€'ëŠ” ë¹¨ê°„ìƒ‰
                }
            } else {
                // ë‚´ìš©ì´ ì—†ì„ ê²½ìš°, í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
                priceTypeField.value = '';
                priceTypeField.classList.remove('text-danger', 'text-primary');
            }
        } catch (error) {
            memoArea.value = `ì˜¤ë¥˜: ë©”ëª¨ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${error})`;
        }
    }
    
    // ê³ ê° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCustomerList() {
        try {
            const response = await fetch('/api/customers');
            const customers = await response.json();
            const select = document.getElementById('customer-history');
            select.innerHTML = '<option value="" selected>ê¸°ì¡´ ê³ ê° ë¶ˆëŸ¬ì˜¤ê¸°...</option>';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        } catch (error) { 
            console.error("ê³ ê° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error); 
        }
    }

    // íŠ¹ì • ê³ ê° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCustomerData() {
        const select = document.getElementById('customer-history');
        const pageId = select.value;
        if (!pageId) return;
        try {
            const response = await fetch(`/api/customer/${pageId}`);
            if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
            const data = await response.json();
            if (data.error) { alert(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${data.error}`); return; }
            
            document.getElementById('customer_name').value = data.customer_name || '';
            document.getElementById('address').value = data.address || '';
            document.getElementById('kb_price').value = (data.kb_price || '').toLocaleString();
            document.getElementById('area').value = data.area || '';
            document.getElementById('ltv1').value = data.ltv1 || '80';
            document.getElementById('ltv2').value = data.ltv2 || '';
            document.getElementById('consult_amt').value = (data.consult_amt || '0').toLocaleString();
            document.getElementById('consult_rate').value = data.consult_rate || '1.5';
            document.getElementById('bridge_amt').value = (data.bridge_amt || '0').toLocaleString();
            document.getElementById('bridge_rate').value = data.bridge_rate || '0.7';
            
            const regionSelect = document.getElementById('deduction_region');
            const regionOption = Array.from(regionSelect.options).find(opt => opt.text === data.deduction_region);
            if(regionOption) {
                regionSelect.selectedIndex = Array.from(regionSelect.options).indexOf(regionOption);
            } else if(regionSelect.options.length > 0) {
                regionSelect.selectedIndex = 0;
            }
            document.getElementById('deduction_amount').value = (regionSelect.value || '').toLocaleString();
            document.getElementById('loan-items-container').innerHTML = '';
            loanItemCounter = 0;

            if (data.loans && data.loans.length > 0) {
                data.loans.forEach(loan => addLoanItem(loan));
            } else { 
                addLoanItem(); 
            }

            triggerMemoGeneration();
        } catch (error) {
            alert(`ê³ ê° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }
    
    // âœ¨ ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜ë“¤
    async function saveNewCustomer() {
        const data = collectAllData();
        if (!data.inputs.customer_name) { 
            alert('ê³ ê°ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
            return; 
        }
        if (!confirm(`'${data.inputs.customer_name}' ì´ë¦„ìœ¼ë¡œ ì‹ ê·œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const response = await fetch('/api/customer/new', { 
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) { 
            loadCustomerList(); 
        }
    }

    async function updateCustomer() {
        const selectedCustomerId = document.getElementById('customer-history').value;
        if (!selectedCustomerId) { 
            alert('ìˆ˜ì •í•  ê³ ê°ì„ ëª©ë¡ì—ì„œ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); 
            return; 
        }
        const data = collectAllData();
        if (!confirm(`'${data.inputs.customer_name}' ê³ ê° ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const url = `/api/customer/update/${selectedCustomerId}`;
        const response = await fetch(url, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
        });
        const result = await response.json();
        alert(result.message);
        if (result.success) { 
            loadCustomerList(); 
        }
    }

    async function deleteCustomer() {
        const select = document.getElementById('customer-history');
        const selectedCustomerId = select.value;

        if (!selectedCustomerId) {
            alert('ì‚­ì œí•  ê³ ê°ì„ ëª©ë¡ì—ì„œ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // --- âœ¨ ìš”ì²­ì‚¬í•­ì— ë§ì¶° ì•”í˜¸ í™•ì¸ ë¡œì§ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤ ---

        // 1. "ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" ë¼ëŠ” ë©”ì‹œì§€ë¡œ í”„ë¡¬í”„íŠ¸ ì°½ì„ ë„ì›ë‹ˆë‹¤.
        const enteredPassword = prompt("ì•”í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

        // 2. ì‚¬ìš©ìê°€ 'ì·¨ì†Œ' ë²„íŠ¼ì„ ëˆŒë €ì„ ê²½ìš°
        if (enteredPassword === null) {
            alert("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤");
            return;
        }

        // 3. ì•”í˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
        const deletePassword = "1245"; // ìš”ì²­í•˜ì‹  ì•”í˜¸ "1245"
        if (enteredPassword === deletePassword) {
            // ì•”í˜¸ê°€ ì¼ì¹˜í•˜ë©´ ì„œë²„ì— ì‚­ì œ ìš”ì²­
            try {
                const url = `/api/customer/delete/${selectedCustomerId}`;
                const response = await fetch(url, { method: 'POST' });
                const result = await response.json();
                alert(result.message); // ì„œë²„ì˜ ì‘ë‹µ ë©”ì‹œì§€ (ì˜ˆ: 'ê³ ê° ì •ë³´ê°€ ì‚­ì œ(ë³´ê´€)ë˜ì—ˆìŠµë‹ˆë‹¤.')
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                alert('ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error('Delete error:', error);
            }
        } else {
            // 4. ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš°
            alert("ì•”í˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì‚­ì œ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
        }
    }

    // PDF íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
    async function handleFileUpload(file) {
        console.log("--- handleFileUpload í•¨ìˆ˜ ì‹¤í–‰ ---");
        const spinner = document.getElementById('upload-spinner');
        spinner.style.display = 'block';
        const formData = new FormData();
        formData.append('pdf_file', file);
        try {
            console.log("ì„œë²„ë¡œ íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ ì „ì†¡...");
            const response = await fetch('/api/upload', { method: 'POST', body: formData });
            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(errorResult.error || `ì„œë²„ ì—ëŸ¬: ${response.status}`);
            }
            const result = await response.json();
            console.log("ì—…ë¡œë“œ ì„±ê³µ. ì„œë²„ ê²°ê³¼:", result);
            if (result.success) {
                const scraped = result.scraped_data;
                document.getElementById('customer_name').value = scraped.customer_name || '';
                document.getElementById('address').value = scraped.address || '';
                document.getElementById('area').value = scraped.area || '';
                if (scraped.owner_shares && scraped.owner_shares.length > 0) {
                    scraped.owner_shares.forEach((line, idx) => {
                        const [nameBirth, shareInfo] = line.split("  ì§€ë¶„ìœ¨ ");
                        const nameField = document.getElementById(`share-customer-name-${idx+1}`);
                        const shareField = document.getElementById(`share-customer-birth-${idx+1}`);
                        if (nameField) nameField.value = nameBirth;
                        if (shareField) shareField.value = "ì§€ë¶„ìœ¨ " + shareInfo;
                    });
                }
                // FileReader APIë¥¼ ì‚¬ìš©í•´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°”ë¡œ PDF í‘œì‹œ
                const fileURL = URL.createObjectURL(file);
                document.getElementById('pdf-viewer').src = fileURL;
                document.getElementById('upload-section').style.display = 'none';
                document.getElementById('viewer-section').style.display = 'block';
                document.getElementById('file-name-display').textContent = file.name;
                triggerMemoGeneration();
            } else { 
                alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`); 
            }
        } catch (error) {
            console.error("!!!!! íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
            alert(`ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        } finally {
            spinner.style.display = 'none';
        }
    }

    // ë ˆì´ì•„ì›ƒ í† ê¸€
    function toggleLayout() {
        const mainContainer = document.getElementById('main-layout-wrapper');
        const btn = document.getElementById('layout-toggle-btn');
        const pdfColumn = document.getElementById('pdf-column');
        const formColumn = document.getElementById('form-column-wrapper');
        const isHorizontal = mainContainer.classList.contains('horizontal-mode');
        
        mainContainer.classList.toggle('horizontal-mode');
        btn.innerHTML = !isHorizontal ? '<i class="bi bi-distribute-vertical"></i> ì„¸ë¡œ ëª¨ë“œ' : '<i class="bi bi-distribute-horizontal"></i> ê°€ë¡œ ëª¨ë“œ';
        
        // ì»¬ëŸ¼ í¬ê¸° ì´ˆê¸°í™”
        if (!isHorizontal) {
            // ê°€ë¡œëª¨ë“œë¡œ ì „í™˜ - flex ê¸°ë°˜ ë°˜ì‘í˜•
            pdfColumn.style.width = '100%';
            pdfColumn.style.height = '';
            pdfColumn.style.flex = '3';
            formColumn.style.width = '100%';
            formColumn.style.height = '';
            formColumn.style.flex = '2';
        } else {
            // ì„¸ë¡œëª¨ë“œë¡œ ì „í™˜
            pdfColumn.style.width = '62.5%';
            pdfColumn.style.height = 'calc(100vh - 2rem)';
            pdfColumn.style.flex = '';
            formColumn.style.width = '37.5%';
            formColumn.style.height = 'calc(100vh - 2rem)';
            formColumn.style.flex = '';
        }
        
        // ë ˆì´ì•„ì›ƒ ìƒíƒœ ì €ì¥
        saveLayoutSettings();
        
        // ë¦¬ì‚¬ì´ì¦ˆ ë°” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬ì„¤ì •
        setTimeout(() => {
            initializeResizeBar();
        }, 100);
    }
    
    // ì „ì²´ ì´ˆê¸°í™”
    function clearAllFields() {
        document.querySelectorAll('.form-field').forEach(field => {
            if(field.tagName === 'SELECT') { 
                field.selectedIndex = 0; 
            } else { 
                field.value = ''; 
            }
        });
        document.getElementById('ltv1').value = '80';
        document.getElementById('consult_rate').value = '1.5';
        document.getElementById('bridge_rate').value = '0.7';
        document.getElementById('deduction_amount').value = document.getElementById('deduction_region').value.toLocaleString();
        document.getElementById('loan-items-container').innerHTML = '';
        loanItemCounter = 0;
        addLoanItem();
        const fileInput = document.getElementById('file-input');
        if (fileInput) fileInput.value = null;
        document.getElementById('pdf-viewer').src = 'about:blank';
        document.getElementById('upload-section').style.display = 'flex';
        document.getElementById('viewer-section').style.display = 'none';
        alert("ëª¨ë“  ì…ë ¥ ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        triggerMemoGeneration();
    }
    
    // ê°œë³„ ì°¨ì£¼ ì§€ë¶„ í•œë„ ê³„ì‚°
    async function calculateIndividualShare() {
        try {
            // ì„ íƒëœ ì°¨ì£¼ ì°¾ê¸°
            const selectedRadio = document.querySelector('input[name="share-borrower"]:checked');
            if (!selectedRadio) return; // ì„ íƒëœ ì°¨ì£¼ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
            
            const ownerIdx = selectedRadio.value;
            
            const kbPriceText = document.getElementById("kb_price").value.replace(/,/g,'') || "0";
            const kbPrice = parseInt(kbPriceText);
            const ltvText = document.getElementById("ltv1").value || "70";
            const ltv = parseFloat(ltvText);

            // ëŒ€ì¶œ ë°ì´í„° ìˆ˜ì§‘
            let loans = [];
            document.querySelectorAll("#loan-items-container .loan-item").forEach(item => {
                const maxAmount = item.querySelector("input[placeholder='ì±„ê¶Œìµœê³ ì•¡']")?.value.replace(/,/g,'') || "0";
                const ratio = item.querySelector("input[placeholder='ë¹„ìœ¨']")?.value || "100";
                const principal = item.querySelector("input[placeholder='ì›ê¸ˆ']")?.value.replace(/,/g,'') || "0";
                const status = item.querySelector("select")?.value || "-";
                
                loans.push({
                    max_amount: parseInt(maxAmount) || 0,
                    ratio: parseFloat(ratio) || 100,
                    principal: parseInt(principal) || 0,
                    status: status
                });
            });

            // ì†Œìœ ì ë°ì´í„° ìˆ˜ì§‘
            const nameField = document.getElementById(`share-customer-name-${ownerIdx}`);
            const shareField = document.getElementById(`share-customer-birth-${ownerIdx}`);
            
            if (!nameField || !shareField || !nameField.value.trim()) {
                return; // ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ
            }
            
            const shareText = shareField.value;
            const shareMatch = shareText.match(/\(([\d.]+)%\)/);
            const sharePercent = shareMatch ? parseFloat(shareMatch[1]) : 0;
            
            if (sharePercent === 0) return; // ì§€ë¶„ìœ¨ì´ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì¢…ë£Œ
            
            let owners = [{
                "ì´ë¦„": nameField.value,
                "ì§€ë¶„ìœ¨": `${sharePercent}%`
            }];

            const payload = {
                total_value: kbPrice,
                ltv: ltv,
                loans: loans,
                owners: owners
            };

            const res = await fetch("/api/calculate_individual_share", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) return; // ì˜¤ë¥˜ ì‹œ ì¡°ìš©íˆ ì¢…ë£Œ
            
            const data = await res.json();

            if (data.success && data.results.length > 0) {
                const result = data.results[0];
                
                // ê¸°ì¡´ ë©”ëª¨ì— ì§€ë¶„ ê³„ì‚° ê²°ê³¼ ì¶”ê°€
                const currentMemo = document.getElementById('generated-memo').value;
                const individualShareMemo = `\n\n--- ê°œë³„ ì§€ë¶„ í•œë„ ê³„ì‚° ---\n${result.ì´ë¦„} ì„ ìˆœìœ„ LTV ${ltv}% ì§€ë¶„ ${result["ìµœì¢…í•œë„(ë§Œì›)"].toLocaleString()}ë§Œ`;
                
                document.getElementById('generated-memo').value = currentMemo + individualShareMemo;
            }
        } catch (error) {
            console.error("ì§€ë¶„ ê³„ì‚° ì˜¤ë¥˜:", error);
        }
    }
    
    // ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìµœì´ˆ ì—°ê²°
    function attachAllEventListeners() {
        const uploadSection = document.getElementById('upload-section');
        const fileInput = document.getElementById('file-input');
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => { 
            if (fileInput.files.length > 0) handleFileUpload(fileInput.files[0]); 
        });
        
        ['dragover','dragleave','drop'].forEach(eventName => {
            uploadSection.addEventListener(eventName, e => { 
                e.preventDefault(); 
                e.stopPropagation(); 
            }, false);
        });
        
        uploadSection.addEventListener('dragover', () => uploadSection.classList.add('dragover'));
        uploadSection.addEventListener('dragleave', () => uploadSection.classList.remove('dragover'));
        uploadSection.addEventListener('drop', (e) => {
            uploadSection.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
        });

        document.querySelectorAll('.manwon-format').forEach(input => {
            input.addEventListener('blur', formatManwonValue);
        });
        
        // ì§€ë¶„ í•œë„ ê³„ì‚°ê¸° ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.querySelectorAll('input[name="share-borrower"]').forEach(radio => {
            radio.addEventListener('change', calculateIndividualShare);
        });
        
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');

        // í‚¤ë³´ë“œë¥¼ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ì´ì ë‹¤ì‹œ ê³„ì‚°
        loanAmountInput.addEventListener('keyup', calculateSimpleInterest);
        annualRateInput.addEventListener('keyup', calculateSimpleInterest);

        // ëŒ€ì¶œê¸ˆì•¡ ì…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ìˆ«ì í¬ë§·íŒ… (ì½¤ë§ˆ ì¶”ê°€)
        loanAmountInput.addEventListener('blur', (e) => {
            const value = e.target.value.replace(/,/g, '');
            const num = parseInt(value, 10);
            if (!isNaN(num) && num > 0) {
                e.target.value = num.toLocaleString();
            } else {
                e.target.value = '';
            }
        });

            // âœ¨ ì›ê¸ˆ ë¶„í•  ê³„ì‚°ê¸° í•¨ìˆ˜ë“¤ ì¶”ê°€
    function formatNumberWithCommas(value) {
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function parseFormattedNumber(value) {
        return Number(value.replace(/,/g, '')) || 0;
    }

    function calculateBalloonLoan() {
        // ê¸°ì¡´ ì´ìê³„ì‚°ê¸° í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
        const loanAmountInput = document.getElementById('interest-loan-amount');
        const annualRateInput = document.getElementById('interest-annual-rate');
        const principalPctInput = document.getElementById('balloon-principal-pct');
        const monthsInput = document.getElementById('balloon-months');

        // ê¸°ì¡´ í•„ë“œê°’ ì‚¬ìš© (ë§Œì› ë‹¨ìœ„ë¥¼ ì› ë‹¨ìœ„ë¡œ ë³€í™˜)
        const loanManwon = parseFloat(loanAmountInput.value.replace(/,/g, '')) || 0;
        const loan = loanManwon * 10000; // ë§Œì›ì„ ì›ìœ¼ë¡œ ë³€í™˜
        const annualRate = Number(annualRateInput.value) || 0;
        const principalPct = Math.max(0, Math.min(100, Number(principalPctInput.value) || 0));
        const months = Number(monthsInput.value) || 0;

        const monthlyRate = annualRate > 0 ? annualRate / 100 / 12 : 0;
        const principalPortion = loan * (principalPct / 100);
        const monthlyPrincipal = months > 0 ? principalPortion / months : 0;
        const firstMonthInterest = loan * monthlyRate;
        const firstMonthPayment = monthlyPrincipal + firstMonthInterest;

        document.getElementById('balloon-monthly-principal').value = Math.round(monthlyPrincipal).toLocaleString() + ' ì›';
        document.getElementById('balloon-first-payment').value = Math.round(firstMonthPayment).toLocaleString() + ' ì›';
        document.getElementById('balloon-first-breakdown').textContent = 
            `(ì›ê¸ˆ ${Math.round(monthlyPrincipal).toLocaleString()} + ì´ì ${Math.round(firstMonthInterest).toLocaleString()})`;
    }

    function handleBalloonLoanInput(event) {
        const input = event.target;
        const value = input.value.replace(/,/g, '');
        const num = parseInt(value, 10);
        
        if (!isNaN(num) && num > 0) {
            input.value = num.toLocaleString();
        } else {
            input.value = '';
        }
        
        calculateBalloonLoan();
    }
        

    // ê¸°ì¡´ ì´ìê³„ì‚°ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ì›ê¸ˆ ë¶„í•  ê³„ì‚° ì¶”ê°€
    loanAmountInput.addEventListener('keyup', () => {
        calculateSimpleInterest();
        calculateBalloonLoan(); // ì¶”ê°€
    });
    annualRateInput.addEventListener('keyup', () => {
        calculateSimpleInterest();
        calculateBalloonLoan(); // ì¶”ê°€
    });
// ì›ê¸ˆ ë¶„í•  ê³„ì‚°ê¸° ì „ìš© í•„ë“œë“¤
const balloonPrincipalPctInput = document.getElementById('balloon-principal-pct');
const balloonMonthsInput = document.getElementById('balloon-months');

if (balloonPrincipalPctInput) {
   balloonPrincipalPctInput.addEventListener('input', calculateBalloonLoan);
   balloonMonthsInput.addEventListener('input', calculateBalloonLoan);
   
   // ì´ˆê¸° ê³„ì‚° ì‹¤í–‰
   calculateBalloonLoan();
}

document.getElementById('load-customer-btn').addEventListener('click', loadCustomerData);
document.getElementById('delete-customer-btn').addEventListener('click', deleteCustomer);
document.getElementById('reset-btn').addEventListener('click', clearAllFields);
document.getElementById('add-loan-btn').addEventListener('click', () => addLoanItem());
document.getElementById('save-new-btn').addEventListener('click', saveNewCustomer);
document.getElementById('update-btn').addEventListener('click', updateCustomer);
document.getElementById('layout-toggle-btn').addEventListener('click', toggleLayout);

// âœ¨ [ìˆ˜ì •] ë°©ê³µì œ ì§€ì—­ ë³€ê²½ ì‹œ ê²½ê³  í™•ì¸ ë¡œì§ë§Œ ìœ ì§€
document.getElementById('deduction_region').addEventListener('change', (e) => {
    // âœ… ì‹ ê·œ ê³ ê°ìš©: ë°©ê³µì œ ê¸ˆì•¡ ìë™ ì„¤ì •
    document.getElementById('deduction_amount').value = e.target.value !== '0' ? 
        parseInt(e.target.value).toLocaleString() : '';
    
    checkTenantDeductionWarning(); 
    triggerMemoGeneration();
});

document.querySelectorAll('.form-field:not(.loan-input)').forEach(field => {
   field.addEventListener('change', triggerMemoGeneration);
   if (field.type === 'text' && !field.classList.contains('manwon-format')) {
       field.addEventListener('keyup', triggerMemoGeneration);
   }
});

document.querySelectorAll('.manwon-format').forEach(input => {
   input.addEventListener('blur', formatManwonValue);
});
}


    // ë¦¬ì‚¬ì´ì¦ˆ ë°” ê¸°ëŠ¥ êµ¬í˜„
    function initializeResizeBar() {
        const resizeBar = document.getElementById('resize-bar');
        const pdfColumn = document.getElementById('pdf-column');
        const formColumn = document.getElementById('form-column-wrapper');
        const mainContainer = document.getElementById('main-layout-wrapper');
        const pdfViewer = document.getElementById('pdf-viewer'); // iframe ìš”ì†Œë¥¼ ë¯¸ë¦¬ ì°¾ì•„ë‘¡ë‹ˆë‹¤.
        
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const newResizeBar = resizeBar.cloneNode(true);
        resizeBar.parentNode.replaceChild(newResizeBar, resizeBar);
        
        let isResizing = false;
        let startPos = 0;
        let startPdfSize = 0;
        
        const isHorizontalMode = () => mainContainer.classList.contains('horizontal-mode');
        
        function startResize(clientX, clientY) {
            isResizing = true;
            
            // [ìˆ˜ì • 1] ë“œë˜ê·¸ë¥¼ ì‹œì‘í•  ë•Œ iframeì˜ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¥¼ 'ëˆë‹¤'.
            pdfViewer.style.pointerEvents = 'none';
            
            // íŠ¸ëœì§€ì…˜ íš¨ê³¼ë¥¼ ì ì‹œ êº¼ì„œ ë“œë˜ê·¸ê°€ ëŠê¸°ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
            pdfColumn.style.transition = 'none';
            formColumn.style.transition = 'none';
            
            // ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ê°€ ì„ íƒë˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
            document.body.style.userSelect = 'none';
            
            if (isHorizontalMode()) {
                startPos = clientY;
                startPdfSize = pdfColumn.getBoundingClientRect().height;
                document.body.style.cursor = 'row-resize';
            } else {
                startPos = clientX;
                startPdfSize = pdfColumn.getBoundingClientRect().width;
                document.body.style.cursor = 'col-resize';
            }
        }
        
        function doResize(clientX, clientY) {
            if (!isResizing) return;
            
            if (isHorizontalMode()) {
                // --- ê°€ë¡œ ëª¨ë“œ (ìƒí•˜ ë¶„í• ) ---
                const deltaY = clientY - startPos;
                const containerHeight = mainContainer.clientHeight;
                const minHeight = 150; // íŒ¨ë„ì´ ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ìµœì†Œ ë†’ì´
                
                let newPdfHeight = startPdfSize + deltaY;
                
                // ìµœì†Œ/ìµœëŒ€ ë†’ì´ ì œí•œì„ ë‘ì–´ ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
                newPdfHeight = Math.max(minHeight, newPdfHeight);
                newPdfHeight = Math.min(containerHeight - minHeight, newPdfHeight);

                const newFormHeight = containerHeight - newPdfHeight - newResizeBar.clientHeight;
                
                const totalFlexHeight = newPdfHeight + newFormHeight;
                pdfColumn.style.flex = `${(newPdfHeight / totalFlexHeight) * 5}`;
                formColumn.style.flex = `${(newFormHeight / totalFlexHeight) * 5}`;
                
            } else {
                // --- ì„¸ë¡œ ëª¨ë“œ (ì¢Œìš° ë¶„í• ) ---
                const deltaX = clientX - startPos;
                const containerWidth = mainContainer.clientWidth;
                const resizeBarWidth = newResizeBar.clientWidth;
                const availableWidth = containerWidth - resizeBarWidth;
                const minWidth = 150; // íŒ¨ë„ì´ ë„ˆë¬´ ì‘ì•„ì§€ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ ìµœì†Œ ë„ˆë¹„

                let newPdfWidth = startPdfSize + deltaX;

                // ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì œí•œì„ ë‘ì–´ ë ˆì´ì•„ì›ƒì´ ê¹¨ì§€ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
                newPdfWidth = Math.max(minWidth, newPdfWidth);
                newPdfWidth = Math.min(availableWidth - minWidth, newPdfWidth);
                
                const pdfPercent = (newPdfWidth / availableWidth) * 100;
                const formPercent = 100 - pdfPercent;
                
                pdfColumn.style.width = `${pdfPercent}%`;
                formColumn.style.width = `${formPercent}%`;
            }
        }
        
        function endResize() {
            if (!isResizing) return;
            isResizing = false;
            
            // [ìˆ˜ì • 2] ë“œë˜ê·¸ê°€ ëë‚˜ë©´ iframeì˜ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¥¼ ë‹¤ì‹œ 'ì¼ ë‹¤'.
            pdfViewer.style.pointerEvents = 'auto';
            
            // ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ë¥¼ ìœ„í•´ íŠ¸ëœì§€ì…˜ì„ ë‹¤ì‹œ í™œì„±í™”í•©ë‹ˆë‹¤.
            pdfColumn.style.transition = '';
            formColumn.style.transition = '';
            
            // í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ ë° ë§ˆìš°ìŠ¤ ì»¤ì„œ ìŠ¤íƒ€ì¼ì„ ì›ë˜ëŒ€ë¡œ ë³µì›í•©ë‹ˆë‹¤.
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            
            // ë¦¬ì‚¬ì´ì¦ˆê°€ ëë‚œ í›„ í˜„ì¬ ë ˆì´ì•„ì›ƒ ìƒíƒœë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
            saveLayoutSettings();
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        newResizeBar.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startResize(e.clientX, e.clientY);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isResizing) {
                e.preventDefault();
                doResize(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', endResize);
        document.addEventListener('mouseleave', endResize); // ë§ˆìš°ìŠ¤ê°€ ì°½ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ë“œë˜ê·¸ê°€ ë©ˆì¶”ë„ë¡ ì¶”ê°€
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼)
        newResizeBar.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            startResize(touch.clientX, touch.clientY);
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (isResizing) {
                e.preventDefault();
                const touch = e.touches[0];
                doResize(touch.clientX, touch.clientY);
            }
        }, { passive: false });
        
        document.addEventListener('touchend', endResize);
        document.addEventListener('touchcancel', endResize);
        
        // ë”ë¸”í´ë¦­ìœ¼ë¡œ ê¸°ë³¸ ë¹„ìœ¨ ë³µì›
        newResizeBar.addEventListener('dblclick', () => {
            if (isHorizontalMode()) {
                pdfColumn.style.flex = '3';
                formColumn.style.flex = '2';
            } else {
                pdfColumn.style.width = '62.5%';
                formColumn.style.width = '37.5%';
            }
            saveLayoutSettings();
        });
    }

    // âœ¨ LTV ë¹„ìœ¨ ì¡°ì • í•¨ìˆ˜ë“¤
    function adjustLtvValue(inputId, change) {
        const input = document.getElementById(inputId);
        let currentValue = parseInt(input.value) || 0;
        
        // ë¹ˆ ê°’ì¼ ë•Œ ë²„íŠ¼ë³„ ë™ì‘
        if (input.value === '' || currentValue === 0) {
            if (change < 0) {
                // - ë²„íŠ¼ ëˆ„ë¥´ë©´ 75ë¡œ ì„¤ì •
                input.value = 75;
            } else {
                // + ë²„íŠ¼ ëˆ„ë¥´ë©´ 85ë¡œ ì„¤ì •
                input.value = 85;
            }
            triggerMemoGeneration();
            return;
        }
        
        let newValue = currentValue + change;
        
        // 0 ë¯¸ë§Œì´ë©´ 0ìœ¼ë¡œ, 200 ì´ˆê³¼í•˜ë©´ 200ìœ¼ë¡œ ì œí•œ (5 ë‹¨ìœ„ ì¡°ì •)
        newValue = Math.max(0, Math.min(200, newValue));
        
        input.value = newValue;
        triggerMemoGeneration();
    }

    function clearLtvValue(inputId) {
        const input = document.getElementById(inputId);
        input.value = '';
        triggerMemoGeneration();
    }

// ê³ ê°ëª… & ìƒë…„ì›”ì¼ ìë™ íŒŒì‹± ê¸°ëŠ¥
function parseCustomerNames() {
    const customerNameField = document.getElementById('customer_name');
    if (!customerNameField) return;
    
    const fullText = customerNameField.value.trim();
    if (!fullText) return;

    const customers = fullText.split(',').map(item => item.trim()).filter(item => item);
    const totalShares = customers.length; // ë‹¨ìˆœíˆ ë™ë“±ë¶„í•  ê°€ì •

    customers.forEach((customer, index) => {
        if (index < 2) {
            const parts = customer.split(' ').filter(part => part.trim());
            if (parts.length >= 2) {
                const name = parts[0];
                const birth = parts[1];
                
                const nameField = document.getElementById(`share-customer-name-${index + 1}`);
                const shareField = document.getElementById(`share-customer-birth-${index + 1}`);
                
                if (nameField) nameField.value = `${name} ${birth}`;
                if (shareField) shareField.value = `1/${totalShares} (${(100/totalShares).toFixed(1)}%)`;
            }
        }
    });
}

// í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', () => {
   addLoanItem();
   attachAllEventListeners();
   loadCustomerList();
   triggerMemoGeneration();
   initializeResizeBar(); // ë¦¬ì‚¬ì´ì¦ˆ ë°” ì´ˆê¸°í™” ì¶”ê°€
   initializeDragAndDrop(); // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ˆê¸°í™” ì¶”ê°€
   
   // ì €ì¥ëœ ë ˆì´ì•„ì›ƒ ì„¤ì • ë³µì›
   setTimeout(() => {
       loadLayoutSettings();
       initializeResizeBar(); // ë ˆì´ì•„ì›ƒ ë³µì› í›„ ë¦¬ì‚¬ì´ì¦ˆ ë°” ì¬ì´ˆê¸°í™”
   }, 200);
   
   // ê³ ê°ëª… & ìƒë…„ì›”ì¼ í•„ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
   const customerNameField = document.getElementById('customer_name');
   if (customerNameField) {
       customerNameField.addEventListener('input', parseCustomerNames);
       customerNameField.addEventListener('change', parseCustomerNames);
       // í˜ì´ì§€ ë¡œë“œì‹œì—ë„ í•œë²ˆ ì‹¤í–‰
       parseCustomerNames();
   }
});

// í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ìë™ ì €ì¥
window.addEventListener('beforeunload', () => {
    saveLayoutSettings();
});

// í˜ì´ì§€ ìˆ¨ê¹€/í‘œì‹œ ì‹œ ì €ì¥ (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ëŒ€ì‘)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        saveLayoutSettings();
    }
});
</script>
</body>
</html>
